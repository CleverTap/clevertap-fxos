!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.clevertap=t()}(this,function(){"use strict";var e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},t=(function(){function e(e){this.value=e}function t(t){var n,r;function i(n,r){try{var s=t[n](r),u=s.value;u instanceof e?Promise.resolve(u.value).then(function(e){i("next",e)},function(e){i("throw",e)}):o(s.done?"return":"normal",s.value)}catch(e){o("throw",e)}}function o(e,t){switch(e){case"return":n.resolve({value:t,done:!0});break;case"throw":n.reject(t);break;default:n.resolve({value:t,done:!1})}(n=n.next)?i(n.key,n.arg):r=null}this._invoke=function(e,t){return new Promise(function(o,s){var u={key:e,arg:t,resolve:o,reject:s,next:null};r?r=r.next=u:(n=r=u,i(e,t))})},"function"!=typeof t.return&&(this.return=void 0)}"function"==typeof Symbol&&Symbol.asyncIterator&&(t.prototype[Symbol.asyncIterator]=function(){return this}),t.prototype.next=function(e){return this._invoke("next",e)},t.prototype.throw=function(e){return this._invoke("throw",e)},t.prototype.return=function(e){return this._invoke("return",e)}}(),function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}),n=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),r=null,i=null,o=null,s=function(){function e(){t(this,e)}return n(e,null,[{key:"setAccountId",value:function(e){r=e}},{key:"getAccountId",value:function(){return r}},{key:"setRegion",value:function(e){i=e}},{key:"getRegion",value:function(){return i}},{key:"setAppVersion",value:function(e){o=e}},{key:"getAppVersion",value:function(){return o}}]),e}(),u={APP_LAUNCHED:"App Launched",CHARGED_ID:"chargedId",ECOOKIE_PREFIX:"CT_E",GCOOKIE_NAME:"CT_G",KCOOKIE_NAME:"CT_K",PCOOKIE_PREFIX:"CT_P",SEQCOOKIE_PREFIX:"CT_SEQ",SCOOKIE_PREFIX:"CT_S",EV_COOKIE:"CT_EV",PR_COOKIE:"CT_PR",ARP_COOKIE:"CT_ARP",UNDEFINED:"undefined",PING_FREQ_IN_MILLIS:12e4,EVENT_TYPES:{EVENT:"event",PROFILE:"profile",PAGE:"page",PING:"ping"},IDENTITY_TYPES:{IDENTITY:"Identity",EMAIL:"Email",FBID:"FBID",GPID:"GPID"}},a="This property has been ignored.",l={init:"Invalid account id",event:"Event structure not valid. Unable to process event",gender:"Gender value should be either M or F. "+a,employed:"Employed value should be either Y or N. "+a,married:"Married value should be either Y or N. "+a,education:"Education value should be either School, College or Graduate. "+a,age:"Age value should be a number. "+a,dob:"DOB value should be a Date Object",objArr:"Expecting Object array in profile",dateFormat:"setDate(number). number should be formatted as yyyymmdd",enumFormat:"setEnum(value). value should be a string or a number",phoneFormat:"Phone number should be formatted as +[country code][number]"},c=[],f=function(){function e(){t(this,e)}return n(e,null,[{key:"pushError",value:function(e,t){c.push({c:e,d:t})}},{key:"popError",value:function(){return c.shift()}}]),e}();f.MESSAGES=l;var v,d={DISABLE:0,ERROR:1,INFO:2,DEBUG:3},g=d.INFO,h={error:function(e){g>=d.ERROR&&p("error",e)},info:function(e){g>=d.INFO&&p("log",e)},debug:function(e){g>=d.DEBUG&&p("debug",e)}},p=function(e,t){if(window.console)try{var n=(new Date).getTime();console[e]("CleverTap ["+n+"]: "+t)}catch(e){}},y=function(e){var t=/^(\d{4})(\d{2})(\d{2})$/.exec(e);if(null===t)return!1;var n=t[3],r=t[2]-1,i=t[1],o=new Date(i,r,n);return o.getDate()===n&&o.getMonth()===r&&o.getFullYear()===i},E=function(e){for(var t in e)if(e.hasOwnProperty(t))return!1;return!0},_=function(e){return"string"==typeof e||e instanceof String},m=function(e){return/^-?[\d.]+(?:e-?\d+)?$/.test(e)&&"number"==typeof e},I=new RegExp("^\\s+|\\.|:|\\$|'|\"|\\\\|\\s+$","g"),S=new RegExp("^\\s+|'|\"|\\\\|\\s+$","g"),b=new RegExp('"',"g"),D=new RegExp("'","g"),P=function(e,t){return e.replace(t,"")},N=function(){try{return window.localStorage.setItem("wzrk_debug","12345678"),window.localStorage.removeItem("wzrk_debug"),"localStorage"in window&&null!==window.localStorage}catch(e){return!1}},O=function(t){if(!t)return null;var n=null;if(N()&&(n=localStorage[t]||null),(void 0===n?"undefined":e(n))!==u.UNDEFINED&&null!==n)try{n=JSON.parse(n)}catch(e){}return n},A={logLevels:d,setLogLevel:function(e){g=e},getLogLevel:function(){return g},log:h,setDate:function(e){if(y(e))return"$D_"+e;h.error(f.MESSAGES.dateFormat)},isDateObject:function(t){return"object"===(void 0===t?"undefined":e(t))&&t instanceof Date},convertToWZRKDate:function(e){return"$D_"+Math.round(e.getTime()/1e3)},isDateValid:y,isArray:function(t){return"object"===(void 0===t?"undefined":e(t))&&t instanceof Array},isObject:function(e){return"[object Object]"===Object.prototype.toString.call(e)},isObjectEmpty:E,isEmptyString:function(e){return!e||0===e.length},isString:_,isConvertibleToNumber:function(e){return!isNaN(parseFloat(e))&&isFinite(e)},isNumber:m,arrayContains:function(e,t){for(var n=e.length;n--;)if(e[n]===t)return!0;return!1},getDomain:function(e){if(""===e)return"";var t=document.createElement("a");return t.href=e,t.hostname},removeUnsupportedChars:function t(n,r){if("object"!==(void 0===n?"undefined":e(n))){var i;return _(n)?(i=P(n,S)).length>1024&&(i=i.substring(0,1024),r&&r(521,i+"... length exceeded 1024 chars. Trimmed.")):i=n,i}for(var o in n)if(n.hasOwnProperty(o)){var s=t(n[o]),u=_(o)?P(o,I):o;_(o)?(u=P(o,I)).length>1024&&(u=u.substring(0,1024),r&&r(520,u+"... length exceeded 1024 chars. Trimmed.")):u=o,delete n[o],n[u]=s}return n},sanitize:P,isLocalStorageSupported:N,getToday:function(){var e=new Date;return e.getFullYear()+""+e.getMonth()+e.getDay()},getNow:function(){return Math.floor((new Date).getTime()/1e3)},unsupportedKeyCharRegex:I,unsupportedValueCharRegex:S,doubleQuoteRegex:b,singleQuoteRegex:D,readFromStorage:O,saveToStorage:function(t,n){if(t&&(void 0===n?"undefined":e(n))!==u.UNDEFINED&&null!==n)try{N()&&(localStorage[t]=JSON.stringify(n))}catch(e){}},removeFromStorage:function(e){e&&N()&&delete localStorage[e]},setEnum:function(e){if(_(e)||m(e))return"$E_"+e;h.error(f.MESSAGES.enumFormat)},reportError:function(e,t){f.pushError(e,t)},isAnonymousDevice:function(){var e=F.getIdentitiesMapKey(),t=O(e)||{};return E(t)}},k=null,T=function(){function e(){t(this,e)}return n(e,null,[{key:"setGUID",value:function(e){k=e;var t=F.getGUIDKey();null===e?F.remove(t):F.save(t,e)}},{key:"getGUID",value:function(){if(!k){var t=F.getGUIDKey();k=F.read(t)}return k||e.generateGUID(),k}},{key:"generateGUID",value:function(){var t="fx"+function e(t){return t?(t^window.crypto.getRandomValues(new Uint8Array(1))[0]%16>>t/4).toString(16):([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,e)}().replace(/[-]/g,"");A.log.debug("Generating Device ID: "+t),e.setGUID(t)}}]),e}(),w=(new RegExp("^\\s+|\\.|:|\\$|'|\"|\\\\|\\s+$","g"),new RegExp("^\\s+|'|\"|\\\\|\\s+$","g"),new RegExp('"',"g"),new RegExp("'","g"),function(){try{return window.localStorage.setItem("wzrk_debug","12345678"),window.localStorage.removeItem("wzrk_debug"),"localStorage"in window&&null!==window.localStorage}catch(e){return!1}}),C=function(t){if(!t)return null;var n=null;if(w()&&(n=localStorage[t]||null),(void 0===n?"undefined":e(n))!==u.UNDEFINED&&null!==n)try{n=JSON.parse(n)}catch(e){}return n},U=C,R=function(t,n){if(t&&(void 0===n?"undefined":e(n))!==u.UNDEFINED&&null!==n)try{w()&&(localStorage[t]=JSON.stringify(n))}catch(e){}},G=function(e){e&&w()&&delete localStorage[e]},F=function(){function e(){t(this,e)}return n(e,null,[{key:"save",value:function(e,t){e&&t&&R(e,t)}},{key:"read",value:function(e){return e?U(e):null}},{key:"remove",value:function(e){e&&G(e)}},{key:"getGUIDKey",value:function(){var e=s.getAccountId();return e?u.GCOOKIE_NAME+"_"+e:null}},{key:"getSessionKey",value:function(){var e=s.getAccountId(),t=T.getGUID();return e&&t?u.SCOOKIE_PREFIX+"_"+e+"_"+t:null}},{key:"getUserEventsKey",value:function(){var e=s.getAccountId(),t=T.getGUID();return e&&t?u.EV_COOKIE+"_"+e+"_"+t:null}},{key:"getUserProfileKey",value:function(){var e=s.getAccountId(),t=T.getGUID();return e&&t?u.PR_COOKIE+"_"+e+"_"+t:null}},{key:"getSavedEventsKey",value:function(){var e=s.getAccountId(),t=T.getGUID();return e&&t?u.ECOOKIE_PREFIX+"_"+e+"_"+t:null}},{key:"getSavedProfilesKey",value:function(){var e=s.getAccountId(),t=T.getGUID();return e&&t?u.PCOOKIE_PREFIX+"_"+e+"_"+t:null}},{key:"getSavedSequenceNumberKey",value:function(){var e=s.getAccountId();return e?u.SEQCOOKIE_PREFIX+"_"+e:null}},{key:"getARPKey",value:function(){var e=s.getAccountId(),t=T.getGUID();return e&&t?u.ARP_COOKIE+"_"+e+"_"+t:null}},{key:"getMetaKey",value:function(){var e=s.getAccountId(),t=T.getGUID();return e&&t?u.META_COOKIE+"_"+e+"_"+t:null}},{key:"getIdentitiesMapKey",value:function(){var e=s.getAccountId();return e?u.KCOOKIE_NAME+"_"+e:null}},{key:"getChargedIdKey",value:function(){var e=s.getAccountId();return e?u.CHARGED_ID+"_"+e:null}}]),e}(),L=0,M=0,K=0,j=0,V=function(){return F.getSessionKey()},x=function(){var e=V(),t=F.read(e)||{};return A.isObject(t)||(t={}),t},q=function(e){var t=V();F.save(t,e)},Y=function(){function e(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};t(this,e),this.options=n,L=A.getNow();var r=x();M=r.ps||0,v=M<=0,j=r.p||1,K=(r.sc||0)+1,r.ps=L,r.p=j,r.sc=K,q(r)}return n(e,[{key:"isFirstSession",value:function(){return v}},{key:"getPageCount",value:function(){return j}},{key:"getTimeElapsed",value:function(){var t=e.getSessionId();return t<=0?0:Math.floor(A.getNow()-t)}},{key:"getTotalVisits",value:function(){return K}},{key:"getLastVisit",value:function(){return M>0?new Date(1e3*M):0}}],[{key:"getSessionId",value:function(){return L}}]),e}(),z={_f:String.fromCharCode,getKeyStr:function(){var e="",t=0;for(t=0;t<=25;t++)e+=String.fromCharCode(t+65);for(t=0;t<=25;t++)e+=String.fromCharCode(t+97);for(t=0;t<10;t++)e+=t;return e+"+/="},convertToFormattedHex:function(e){var t,n,r,i="";if(!A.isArray(e))return!1;for(n=e.length,t=0;t<n;++t)e[t]<0&&(e[t]=e[t]+256),void 0===e[t]&&(e[t]=0),1===(r=e[t].toString(16)).length&&(r="0"+r),i+=r;return i.trim()},convertStringToHex:function(e){for(var t=[],n=0;n<e.length;n++){var r=e.charCodeAt(n);t.push(255&r),t.push(r>>8&255)}return z.convertToFormattedHex(t)},compressToBase64:function(e){if(null===e)return"";var t,n,r,i,o,s,u,a="",l=0;for(e=z.compress(e);l<2*e.length;)l%2==0?(t=e.charCodeAt(l/2)>>8,n=255&e.charCodeAt(l/2),r=l/2+1<e.length?e.charCodeAt(l/2+1)>>8:NaN):(t=255&e.charCodeAt((l-1)/2),(l+1)/2<e.length?(n=e.charCodeAt((l+1)/2)>>8,r=255&e.charCodeAt((l+1)/2)):n=r=NaN),l+=3,i=t>>2,o=(3&t)<<4|n>>4,s=(15&n)<<2|r>>6,u=63&r,isNaN(n)?s=u=64:isNaN(r)&&(u=64),a=a+z._keyStr.charAt(i)+z._keyStr.charAt(o)+z._keyStr.charAt(s)+z._keyStr.charAt(u);return a},compress:function(e){if(null===e)return"";var t,n,r,i={},o={},s="",u="",a="",l=2,c=3,f=2,v="",d=0,g=0,h=z._f;for(r=0;r<e.length;r+=1)if(s=e.charAt(r),Object.prototype.hasOwnProperty.call(i,s)||(i[s]=c++,o[s]=!0),u=a+s,Object.prototype.hasOwnProperty.call(i,u))a=u;else{if(Object.prototype.hasOwnProperty.call(o,a)){if(a.charCodeAt(0)<256){for(t=0;t<f;t++)d<<=1,15===g?(g=0,v+=h(d),d=0):g++;for(n=a.charCodeAt(0),t=0;t<8;t++)d=d<<1|1&n,15===g?(g=0,v+=h(d),d=0):g++,n>>=1}else{for(n=1,t=0;t<f;t++)d=d<<1|n,15===g?(g=0,v+=h(d),d=0):g++,n=0;for(n=a.charCodeAt(0),t=0;t<16;t++)d=d<<1|1&n,15===g?(g=0,v+=h(d),d=0):g++,n>>=1}0===--l&&(l=Math.pow(2,f),f++),delete o[a]}else for(n=i[a],t=0;t<f;t++)d=d<<1|1&n,15===g?(g=0,v+=h(d),d=0):g++,n>>=1;0===--l&&(l=Math.pow(2,f),f++),i[u]=c++,a=String(s)}if(""!==a){if(Object.prototype.hasOwnProperty.call(o,a)){if(a.charCodeAt(0)<256){for(t=0;t<f;t++)d<<=1,15===g?(g=0,v+=h(d),d=0):g++;for(n=a.charCodeAt(0),t=0;t<8;t++)d=d<<1|1&n,15===g?(g=0,v+=h(d),d=0):g++,n>>=1}else{for(n=1,t=0;t<f;t++)d=d<<1|n,15===g?(g=0,v+=h(d),d=0):g++,n=0;for(n=a.charCodeAt(0),t=0;t<16;t++)d=d<<1|1&n,15===g?(g=0,v+=h(d),d=0):g++,n>>=1}0===--l&&(l=Math.pow(2,f),f++),delete o[a]}else for(n=i[a],t=0;t<f;t++)d=d<<1|1&n,15===g?(g=0,v+=h(d),d=0):g++,n>>=1;0===--l&&(l=Math.pow(2,f),f++)}for(n=2,t=0;t<f;t++)d=d<<1|1&n,15===g?(g=0,v+=h(d),d=0):g++,n>>=1;for(;;){if(d<<=1,15===g){v+=h(d);break}g++}return v}};z._keyStr=z.getKeyStr();var B,$,J={compressToBase64:z.compressToBase64},Q=function(e){return A.log.debug("dobj:"+e),J.compressToBase64(e)},H=function(t){var n={};if(e(t.displayName)!==u.UNDEFINED&&(n.Name=t.displayName),e(t.id)!==u.UNDEFINED&&(n.GPID=t.id+""),e(t.gender)!==u.UNDEFINED&&("male"===t.gender?n.Gender="M":"female"===t.gender?n.Gender="F":"other"===t.gender&&(n.Gender="O")),e(t.image)!==u.UNDEFINED&&(t.image.isDefault||(n.Photo=t.image.url.split("?sz")[0])),e(t.emails)!==u.UNDEFINED)for(var r=0;r<t.emails.length;r++){var i=t.emails[r];"account"===i.type&&(n.Email=i.value)}if(t.organizations){n.Employed="N";for(var o=0;o<t.organizations.length;o++){if("work"===t.organizations[o].type){n.Employed="Y";break}}}if(t.birthday){var s=t.birthday.split("-");n.DOB=A.setDate(s[0]+s[1]+s[2])}return t.relationshipStatus&&(n.Married="N","married"===t.relationshipStatus&&(n.Married="Y")),A.log.debug("gplus usr profile "+JSON.stringify(n)),n},X=function(e){var t={};t.Name=e.name,e.id&&(t.FBID=e.id+""),"male"===e.gender?t.Gender="M":"female"===e.gender?t.Gender="F":t.Gender="O";e.relationship_status&&(t.Married="N","Married"===e.relationship_status&&(t.Married="Y"));var n=function(e){if(e){for(var t="",n="",r=0;r<e.length;r++){var i=e[r];if(i.type){var o=i.type;if("Graduate School"===o)return"Graduate";"College"===o?t="1":"High School"===o&&(n="1")}}if("1"===t)return"College";if("1"===n)return"School"}}(e.education);if(n&&(t.Education=n),t.Employed=e.work?"Y":"N",e.email&&(t.Email=e.email),e.birthday){var r=e.birthday.split("/");t.DOB=A.setDate(r[2]+r[0]+r[1])}return t},W=void 0,Z=function(e){if(A.isObject(e)){for(var t in e)if(e.hasOwnProperty(t)){if(A.isObject(e[t])||A.isArray(e[t]))return!1;A.isDateObject(e[t])&&(e[t]=A.convertToWZRKDate(e[t]))}return!0}return!1},ee=Z,te=function(t){var n=!0;if(A.isObject(t))for(var r in t)if(t.hasOwnProperty(r)){var i=t[r];if((void 0===i?"undefined":e(i))===u.UNDEFINED){delete t[r];continue}"Gender"!==r||i.match(/^M$|^F$/)||(n=!1,A.log.error(f.MESSAGES.gender)),"Employed"!==r||i.match(/^Y$|^N$/)||(n=!1,A.log.error(f.MESSAGES.employed)),"Married"!==r||i.match(/^Y$|^N$/)||(n=!1,A.log.error(f.MESSAGES.married)),"Education"!==r||i.match(/^School$|^College$|^Graduate$/)||(n=!1,A.log.error(f.MESSAGES.education)),"Age"===r&&(void 0===i?"undefined":e(i))!==u.UNDEFINED&&(A.isConvertibleToNumber(i)?t.Age=+i:(n=!1,A.log.error(f.MESSAGES.age))),"DOB"===r?(/^\$D_/.test(i)&&11===(i+"").length||A.isDateObject(i)||(n=!1,A.log.error(f.MESSAGES.dob)),A.isDateObject(i)&&(t[r]=A.convertToWZRKDate(i))):A.isDateObject(i)&&(t[r]=A.convertToWZRKDate(i)),"Phone"!==r||A.isObjectEmpty(i)||(i.length>8&&"+"===i.charAt(0)?(i=i.substring(1,i.length),A.isConvertibleToNumber(i)?t.Phone=+i:(n=!1,A.log.error(f.MESSAGES.phoneFormat+". Removed."))):(n=!1,A.log.error(f.MESSAGES.phoneFormat+". Removed."))),n||delete t[r]}return n},ne=function(t,n){if(A.isObject(t)){for(var r in t)if(t.hasOwnProperty(r))if("Items"===r){if(!A.isArray(t[r]))return!1;t[r].length>16&&n&&n(522,"Charged Items exceed 16 limit. Actual count: "+t[r].length+". Additional items will be dropped.");for(var i in t[r])if(t[r].hasOwnProperty(i)&&(!A.isObject(t[r][i])||!Z(t[r][i])))return!1}else{if(A.isObject(t[r])||A.isArray(t[r]))return!1;A.isDateObject(t[r])&&(t[r]=A.convertToWZRKDate(t[r]))}if(e(t[u.CHARGED_ID])!==u.UNDEFINED){var o=t[u.CHARGED_ID],s=F.getChargedIdKey();if((void 0===W?"undefined":e(W))===u.UNDEFINED&&(W=F.read(s)),(void 0===W?"undefined":e(W))!==u.UNDEFINED&&W===o)return A.log.error("Duplicate charged Id - Dropped"+t),!1;W=o,F.save(s,o)}return!0}return!1},re=[],ie=function(){function e(n,r){if(t(this,e),this.api=n,re.push=function(t){var n=e.generateProfileObj(t),r=e.generateProfileEvent(n);this.api.processEvent(r)}.bind(this),r&&r.length>0)for(var i=0;i<r.length;i++)this.push(r[i])}return n(e,[{key:"push",value:function(){return re.push(Array.prototype.slice.call(arguments)),!0}},{key:"getAttribute",value:function(e){return this.api.getProfileAttribute(e)}}],[{key:"getCachedGUIDForIdentity",value:function(e,t){if(!e||!t)return null;var n=F.getIdentitiesMapKey();if(!n)return null;return(F.read(n)||{})[e+"_"+t]||null}},{key:"extractIdentifiersFromProfileObj",value:function(e){if(!e||A.isObjectEmpty(e))return null;var t=[];return e.Email&&t.push({type:u.IDENTITY_TYPES.EMAIL,id:e.Email}),e.GPID&&t.push({type:u.IDENTITY_TYPES.GPID,id:e.GPID}),e.FBID&&t.push({type:u.IDENTITY_TYPES.FBID,id:e.FBID}),e.Identity&&t.push({type:u.IDENTITY_TYPES.IDENTITY,id:e.Identity}),t}},{key:"generateProfileObj",value:function(e){var t;if(!A.isArray(e)||e.length<=0)return null;for(var n=0;n<e.length;n++){var r=e[n];if(t=null,r.Site){if(t=r.Site,A.isObjectEmpty(t)||!te(t))return null}else if(r.Facebook){var i=r.Facebook;A.isObjectEmpty(i)||i.error||(t=X(i))}else if(r["Google Plus"]){var o=r["Google Plus"];A.isObjectEmpty(o)||o.error||(t=H(o))}if(t&&!A.isObjectEmpty(t)){t.tz||(t.tz=(new Date).toString().match(/([A-Z]+[\+-][0-9]+)/)[1]);break}}return t}},{key:"generateProfileEvent",value:function(t){if(!t||A.isObjectEmpty(t))return null;var n=e.extractIdentifiersFromProfileObj(t);return n.length>0&&function(e){var t=F.getIdentitiesMapKey(),n=T.getGUID();if(n&&e&&!(e.length<=0)){for(var r=F.read(t)||{},i=0;i<e.length;i++){var o=e[i];o.type&&o.id&&(r[o.type+"_"+o.id]=n)}F.save(t,r)}}(n),{ep:A.getNow(),type:u.EVENT_TYPES.PROFILE,profile:t}}}]),e}(),oe=function(){function e(n,r){t(this,e),this.url=n,this.data=r||[]}return n(e,[{key:"send",value:function(e){var t=new XMLHttpRequest({mozSystem:!0});t.open("post",this.url,!0),t.responseType="json",t.addEventListener("error",function(){e&&e(t.status,t.error)}),t.addEventListener("load",function(){e&&e(t.status,t.response)}),t.setRequestHeader("Accept","application/json"),t.setRequestHeader("Content-Type","application/json"),t.send(JSON.stringify(this.data)),A.log.debug("req snt -> url: "+this.url)}}]),e}(),se=function(e){var t=F.read(e);return A.isArray(t)?t:[]},ue=function(e){var t=F.read(e)||0;return parseInt(t,10)},ae=function(){return F.getSavedEventsKey()},le=function(){return F.getSavedProfilesKey()},ce=function(){return F.getSavedSequenceNumberKey()},fe=function(){return F.getARPKey()},ve=function(){function e(n){t(this,e),this.options=n,this.options.eventUploadRetryInterval=this.options.eventUploadInterval,this._uploading=!1,this._requestScheduled=!1,this._unsentEvents=se(ae()),this._unsentProfiles=se(le()),this._sequenceNumber=ue(ce()),this._scheduleEvents()}return n(e,[{key:"clearEvents",value:function(e){var t=this;this._sendEvents(function(){t._unsentEvents=[],t._unsentProfiles=[],t._saveEvents(),e()})}},{key:"queueEvent",value:function(e){if(e){e._seq=this._nextSequenceNumber();A.log.debug("Queuing event "+JSON.stringify(e)),e.type===u.EVENT_TYPES.PROFILE?this._unsentProfiles.push(e):this._unsentEvents.push(e),this._saveEvents(),this._scheduleEvents()}}},{key:"_getEndPoint",value:function(){return s.getRegion()&&(this.options.domain=s.getRegion()+"."+this.options.domain),this.options.protocol+"//"+this.options.domain+"/a2?t=77"}},{key:"_unsentCount",value:function(){return this._unsentEvents.length+this._unsentProfiles.length}},{key:"_scheduleRetry",value:function(){this.options.eventUploadRetryInterval=2*this.options.eventUploadRetryInterval,this._scheduleEvents(null,!0)}},{key:"_scheduleEvents",value:function(e,t){if(0===this._unsentCount())return A.log.debug("No events in the queue, not scheduling an event update"),!1;if(this._unsentCount()>=this.options.eventUploadThreshold)return this._sendEvents(e),!0;if(this._requestScheduled)return A.log.debug("Event upload already scheduled"),!1;this._requestScheduled=!0;var n=t?this.options.eventUploadRetryInterval:this.options.eventUploadInterval;return setTimeout(function(){this._requestScheduled=!1,this._sendEvents(e)}.bind(this),n),A.log.debug("Scheduling an event upload in "+n/1e3+" seconds"),!1}},{key:"_sendEvents",value:function(e){var t=!1,n="";if(this._uploading&&(t=!0,n="Already Uploading"),this._unsentCount()<=0&&(t=!0,n="No events in the queue"),t){var r="Skipping events upload: "+n;return A.log.debug(r),void("function"==typeof e&&e(0,r))}this._uploading=!0;var i=this._getEndPoint();i=this._addToURL(i,"sn",A.getNow()),i=this._addARPToRequest(i),i=this._addToURL(i,"r",(new Date).getTime());var o={id:s.getAccountId(),"SDK Version":1e4,s:""+Y.getSessionId()};s.getAppVersion()&&(o.Version=""+s.getAppVersion());var u=T.getGUID();u&&(i=this._addToURL(i,"gc",u),o.g=u),i=this._addToURL(i,"d",Q(JSON.stringify(o)));var a=Math.min(this._unsentCount(),this.options.uploadBatchSize),l=this._mergeEventQueues(a),c=l.maxEventId,f=l.maxProfilesId,v=l.eventsToSend;A.log.debug("Sending events: "+JSON.stringify(v));var d=this;new oe(i,v).send(function(t,n){d._uploading=!1,n=n||{},A.log.debug("handling response with status: "+t+" and data: "+JSON.stringify(n));try{200===t?(n.g&&T.setGUID(n.g),d._removeEvents(c,f),d._saveEvents(),d._updateARP(n),d._scheduleEvents(e)||"function"!=typeof e||e(t,n)):413===t?(A.log.error("event upload request too large"),1===d.options.uploadBatchSize&&d._removeEvents(c,f),d.options.uploadBatchSize=Math.ceil(a/2),d._sendEvents(e)):(A.log.error("Events upload failed with status "+t+".  Will retry."),d._scheduleRetry(),"function"==typeof e&&e(t,n))}catch(e){d._uploading=!1,A.log.error("Events upload failed: "+e.message+".  Will retry."),d._scheduleRetry()}})}},{key:"_saveEvents",value:function(){F.save(ae(),this._unsentEvents),F.save(le(),this._unsentProfiles)}},{key:"_trimEventsQueued",value:function(e){e.length>this.options.maxSavedEventCount&&e.splice(0,e.length-this.options.maxSavedEventCount)}},{key:"_removeEvents",value:function(e,t){this._removeEventsFromQueue("_unsentEvents",e),this._removeEventsFromQueue("_unsentProfiles",t)}},{key:"_removeEventsFromQueue",value:function(e,t){if(!(t<0)){for(var n=[],r=0;r<this[e].length;r++)this[e][r]._seq>t&&n.push(this[e][r]);this[e]=n}}},{key:"_nextSequenceNumber",value:function(){return this._sequenceNumber++,F.save(ce(),this._sequenceNumber),this._sequenceNumber}},{key:"_mergeEventQueues",value:function(e){for(var t=[],n=0,r=-1,i=0,o=-1;t.length<e;){var s,u=i>=this._unsentProfiles.length,a=n>=this._unsentEvents.length;if(a&&u){A.log.error("Problem merging event queues, fewer events than expected");break}u?r=(s=this._unsentEvents[n++])._seq:a?o=(s=this._unsentProfiles[i++])._seq:this._unsentEvents[n]._seq<this._unsentProfiles[i]._seq?r=(s=this._unsentEvents[n++])._seq:o=(s=this._unsentProfiles[i++])._seq,t.push(s)}return{eventsToSend:t,maxEventId:r,maxProfilesId:o}}},{key:"_updateARP",value:function(){var e=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).arp;if(e){var t=fe();try{var n=F.read(t)||{};for(var r in e)e.hasOwnProperty(r)&&(-1===e[r]?delete n[r]:n[r]=e[r]);F.save(t,n)}catch(e){A.log.error("Unable to parse ARP JSON: "+e)}}}},{key:"_addARPToRequest",value:function(e){var t=fe();if(!t)return e;var n=F.read(t);return n?this._addToURL(e,"arp",Q(JSON.stringify(n))):e}},{key:"_addToURL",value:function(e,t,n){return e+"&"+t+"="+encodeURIComponent(n)}}]),e}(),de=function(e,t){var n={type:e,ep:A.getNow()};t&&t(n)},ge=function(){function e(n){t(this,e),this.options=n,this.queueManager=new ve(Object.assign({},this.options)),this._newSession()}return n(e,[{key:"getCleverTapID",value:function(){return T.getGUID()}},{key:"getTimeElapsed",value:function(){return this._isPersonalizationActive()?this.session.getTimeElapsed():0}},{key:"getPageCount",value:function(){return this._isPersonalizationActive()?this.session.getPageCount():0}},{key:"getTotalVisits",value:function(){return this._isPersonalizationActive()?this.session.getTotalVisits():0}},{key:"getLastVisit",value:function(){return this._isPersonalizationActive()?this.session.getLastVisit():0}},{key:"getEventDetails",value:function(e){if(this._isPersonalizationActive()){var t=this._getEventsMap()[e];if(!t)return null;var n={};return n.firstTime=new Date(1e3*t[1]),n.lastTime=new Date(1e3*t[2]),n.count=t[0],n}}},{key:"getProfileAttribute",value:function(e){if(this._isPersonalizationActive())return this._getProfilesMap()[e]}},{key:"processEvent",value:function(e){A.isObject(e)&&(e.type===u.EVENT_TYPES.EVENT&&this._addToLocalEventMap(e.evtName),e.type===u.EVENT_TYPES.PROFILE&&this._addToLocalProfileMap(e.profile),e=this._addSystemDataToObject(e,void 0),this.queueManager.queueEvent(e))}},{key:"onUserLogin",value:function(e){var t=this,n=ie.generateProfileObj(e),r=T.getGUID();if(r&&n){for(var i,o=ie.extractIdentifiersFromProfileObj(n)||[],s=o.length>0,u=0;u<o.length;u++){var a=o[u];if(a.type&&a.id&&(i=ie.getCachedGUIDForIdentity(a.type,a.id)))break}return!s||A.isAnonymousDevice()?(A.log.debug("onUserLogin: either don't have identifier or device is anonymous, associating profile "+JSON.stringify(n)+" with current user profile"),void this._processProfileEvent(n)):i&&i===r?(A.log.debug("onUserLogin: profile "+JSON.stringify(n)+" maps to current device id "+r+", using current user profile"),void this._processProfileEvent(n)):void(this.processingUserLogin?A.log.debug("Already processing onUserLogin for "+this.processingUserLoginKey+" , will not process for profile: "+JSON.stringify(n)):(this.processingUserLogin=!0,this.processingUserLoginKey=JSON.stringify(n),A.log.debug("Processing onUserLogin for "+this.processingUserLoginKey),this.queueManager.clearEvents(function(){i?T.setGUID(i):T.generateGUID(),t._clearDataMaps(),t._newSession(),t._processProfileEvent(n),t.processingUserLogin=!1,t.processingUserLoginKey=null})))}}},{key:"_newSession",value:function(){this.session=new Y(Object.assign({},this.options)),this._generateLaunchEvents()}},{key:"_generateLaunchEvents",value:function(){var e=this;t=function(t){e.processEvent(t)},de(u.EVENT_TYPES.EVENT,function(e){e.evtName=u.APP_LAUNCHED,e.evtData={"SDK Version":1e4},s.getAppVersion()&&(e.evtData.Version=""+s.getAppVersion()),t&&t(e)});var t;this.options.sendPages&&de(u.EVENT_TYPES.PAGE,function(t){e.processEvent(t)})}},{key:"_getEventsMap",value:function(){if(!B){var e=F.getUserEventsKey();B=F.read(e)||{}}return B}},{key:"_getProfilesMap",value:function(){if(!$){var e=F.getUserProfileKey();$=F.read(e)||{}}return $}},{key:"_clearDataMaps",value:function(){B=null,$=null}},{key:"_startPings",value:function(){if(this.options.sendPings){var e=this;setInterval(function(){de(u.EVENT_TYPES.PING,function(t){e.processEvent(t)})},u.PING_FREQ_IN_MILLIS)}}},{key:"_isPersonalizationActive",value:function(){return this.options.enablePersonalization}},{key:"_processProfileEvent",value:function(e){var t=ie.generateProfileEvent(e);this.processEvent(t)}},{key:"_addToLocalEventMap",value:function(e){if(e){var t=this._getEventsMap(),n=A.getNow(),r=t[e];r?(r[2]=n,r[0]++):((r=[]).push(1),r.push(n),r.push(n)),t[e]=r;var i=F.getUserEventsKey();F.save(i,t)}}},{key:"_addToLocalProfileMap",value:function(e){if(e){var t=this._getProfilesMap();if(e._custom){var n=e._custom;for(var r in n)n.hasOwnProperty(r)&&(e[r]=n[r]);delete e._custom}for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);t._custom&&delete t._custom;var o=F.getUserProfileKey();F.save(o,t)}}},{key:"_addSystemDataToObject",value:function(e,t){t||(e=A.removeUnsupportedChars(e,function(e,t){A.reportError(e,t)}));var n=f.popError();return n&&(e.wzrk_error=n),e.id=s.getAccountId(),T.getGUID()&&(e.g=T.getGUID()),e.s=Y.getSessionId(),e.pg=this.session.getPageCount(),e.f=this.session.isFirstSession(),e}}]),e}(),he=[],pe=function(e){if(A.isArray(e)){for(var t=function(e,t){A.reportError(e,t)},n=null;e.length>0;){var r=e.shift();if(!A.isString(r))return void A.log.error(f.MESSAGES.event);if(r.length>1024&&(r=r.substring(0,1024),A.reportError(510,r+"... length exceeded 1024 chars. Trimmed.")),"Stayed"!==r&&"UTM Visited"!==r&&"App Launched"!==r&&"Notification Sent"!==r&&"Notification Viewed"!==r&&"Notification Clicked"!==r){if(n={type:u.EVENT_TYPES.EVENT,ep:A.getNow(),evtName:A.sanitize(r,A.unsupportedKeyCharRegex)},0!==e.length){var i=e.shift();if(A.isObject(i)){if("Charged"===r){if(ne(i),t){A.reportError(511,"Charged event structure invalid. Not sent.");continue}}else if(!ee(i)){A.reportError(512,r+" event structure invalid. Not sent.");continue}n.evtData=i}else e.unshift(i)}}else A.reportError(513,r+" is a restricted system event. It cannot be used as an event name.")}return n}},ye=function(){function e(n,r){if(t(this,e),this.api=n,he.push=function(e){var t=pe(e);this.api.processEvent(t)}.bind(this),r&&r.length>0)for(var i=0;i<r.length;i++)this.push(r[i])}return n(e,[{key:"push",value:function(){return he.push(Array.prototype.slice.call(arguments)),!0}},{key:"getDetails",value:function(e){return this.api.getEventDetails(e)}}]),e}(),Ee={domain:"wzrkt.com",protocol:"https:",enablePersonalization:!0,eventUploadInterval:1e3,eventUploadThreshold:50,maxSavedEventCount:1e3,uploadBatchSize:50,sendPages:!1,sendPings:!1},_e=function(){function e(n){t(this,e),this.api=n}return n(e,[{key:"getTimeElapsed",value:function(){return this.api.getTimeElapsed()}},{key:"getPageCount",value:function(){return this.api.getPageCount()}}]),e}(),me=function(){function e(n){t(this,e),this.api=n}return n(e,[{key:"getTotalVisits",value:function(){return this.api.getTotalVisits()}},{key:"getLastVisit",value:function(){return this.api.getLastVisit()}}]),e}(),Ie=[],Se=function(){function e(n,r){if(t(this,e),this.api=n,Ie.push=function(e){this.api.onUserLogin(e)}.bind(this),r&&r.length>0)for(var i=0;i<r.length;i++)this.push(r[i])}return n(e,[{key:"push",value:function(){return Ie.push(Array.prototype.slice.call(arguments)),!0}}]),e}();return new(function(){function e(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};t(this,e),this.options=Object.assign({},Ee),this.event=n.event||[],this.profile=n.profile||[],this.onUserLogin=n.onUserLogin||[],this.logLevels=A.logLevels}return n(e,[{key:"init",value:function(e,t){A.isEmptyString(e)?A.log.error(f.MESSAGES.init):(s.setAccountId(e),s.setRegion(t),this.api=new ge(Object.assign({},this.options)),this.session=new _e(this.api),this.user=new me(this.api),this.onUserLogin=new Se(this.api,this.onUserLogin),this.event=new ye(this.api,this.event),this.profile=new ie(this.api,this.profile))}},{key:"getCleverTapID",value:function(){return this.api.getCleverTapID()}},{key:"setLogLevel",value:function(e){A.setLogLevel(e)}},{key:"getLogLevel",value:function(){return A.getLogLevel()}},{key:"setAppVersion",value:function(e){s.setAppVersion(e)}},{key:"getAppVersion",value:function(){return s.getAppVersion()}}]),e}())(window.clevertap)});
