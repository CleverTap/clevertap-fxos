!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.clevertap=t()}(this,function(){"use strict";var u="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},i=(function(){function l(e){this.value=e}function e(i){var o,s;function u(e,t){try{var n=i[e](t),r=n.value;r instanceof l?Promise.resolve(r.value).then(function(e){u("next",e)},function(e){u("throw",e)}):a(n.done?"return":"normal",n.value)}catch(e){a("throw",e)}}function a(e,t){switch(e){case"return":o.resolve({value:t,done:!0});break;case"throw":o.reject(t);break;default:o.resolve({value:t,done:!1})}(o=o.next)?u(o.key,o.arg):s=null}this._invoke=function(r,i){return new Promise(function(e,t){var n={key:r,arg:i,resolve:e,reject:t,next:null};s?s=s.next=n:(o=s=n,u(r,i))})},"function"!=typeof i.return&&(this.return=void 0)}"function"==typeof Symbol&&Symbol.asyncIterator&&(e.prototype[Symbol.asyncIterator]=function(){return this}),e.prototype.next=function(e){return this._invoke("next",e)},e.prototype.throw=function(e){return this._invoke("throw",e)},e.prototype.return=function(e){return this._invoke("return",e)}}(),function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}),o=function(){function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e}}(),t=null,n=null,r=null,d=function(){function e(){i(this,e)}return o(e,null,[{key:"setAccountId",value:function(e){t=e}},{key:"getAccountId",value:function(){return t}},{key:"setRegion",value:function(e){n=e}},{key:"getRegion",value:function(){return n}},{key:"setAppVersion",value:function(e){r=e}},{key:"getAppVersion",value:function(){return r}}]),e}(),s={APP_LAUNCHED:"App Launched",CHARGED_ID:"chargedId",ECOOKIE_PREFIX:"CT_E",GCOOKIE_NAME:"CT_G",KCOOKIE_NAME:"CT_K",PCOOKIE_PREFIX:"CT_P",SEQCOOKIE_PREFIX:"CT_SEQ",SCOOKIE_PREFIX:"CT_S",EV_COOKIE:"CT_EV",PR_COOKIE:"CT_PR",ARP_COOKIE:"CT_ARP",UNDEFINED:"undefined",PING_FREQ_IN_MILLIS:12e4,EVENT_TYPES:{EVENT:"event",PROFILE:"profile",PAGE:"page",PING:"ping"},IDENTITY_TYPES:{IDENTITY:"Identity",EMAIL:"Email",FBID:"FBID",GPID:"GPID"}},e="This property has been ignored.",a={init:"Invalid account id",event:"Event structure not valid. Unable to process event",gender:"Gender value should be either M or F. "+e,employed:"Employed value should be either Y or N. "+e,married:"Married value should be either Y or N. "+e,education:"Education value should be either School, College or Graduate. "+e,age:"Age value should be a number. "+e,dob:"DOB value should be a Date Object",objArr:"Expecting Object array in profile",dateFormat:"setDate(number). number should be formatted as yyyymmdd",enumFormat:"setEnum(value). value should be a string or a number",phoneFormat:"Phone number should be formatted as +[country code][number]"},l=[],c=function(){function e(){i(this,e)}return o(e,null,[{key:"pushError",value:function(e,t){l.push({c:e,d:t})}},{key:"popError",value:function(){return l.shift()}}]),e}();c.MESSAGES=a;var f,v={DISABLE:0,ERROR:1,INFO:2,DEBUG:3},g=v.INFO,h={error:function(e){v.ERROR<=g&&p("error",e)},info:function(e){v.INFO<=g&&p("log",e)},debug:function(e){v.DEBUG<=g&&p("debug",e)}},p=function(e,t){if(window.console)try{var n=(new Date).getTime();console[e]("CleverTap ["+n+"]: "+t)}catch(e){}},y=function(e){var t=/^(\d{4})(\d{2})(\d{2})$/.exec(e);if(null===t)return!1;var n=t[3],r=t[2]-1,i=t[1],o=new Date(i,r,n);return o.getDate()===n&&o.getMonth()===r&&o.getFullYear()===i},E=function(e){for(var t in e)if(e.hasOwnProperty(t))return!1;return!0},_=function(e){return"string"==typeof e||e instanceof String},m=function(e){return/^-?[\d.]+(?:e-?\d+)?$/.test(e)&&"number"==typeof e},I=new RegExp("^\\s+|\\.|:|\\$|'|\"|\\\\|\\s+$","g"),S=new RegExp("^\\s+|'|\"|\\\\|\\s+$","g"),b=new RegExp('"',"g"),D=new RegExp("'","g"),P=function(e,t){return e.replace(t,"")},N=function(){try{return window.localStorage.setItem("wzrk_debug","12345678"),window.localStorage.removeItem("wzrk_debug"),"localStorage"in window&&null!==window.localStorage}catch(e){return!1}},O=function(e){if(!e)return null;var t=null;if(N()&&(t=localStorage[e]||null),(void 0===t?"undefined":u(t))!==s.UNDEFINED&&null!==t)try{t=JSON.parse(t)}catch(e){}return t},A={logLevels:v,setLogLevel:function(e){g=e},getLogLevel:function(){return g},log:h,setDate:function(e){if(y(e))return"$D_"+e;h.error(c.MESSAGES.dateFormat)},isDateObject:function(e){return"object"===(void 0===e?"undefined":u(e))&&e instanceof Date},convertToWZRKDate:function(e){return"$D_"+Math.round(e.getTime()/1e3)},isDateValid:y,isArray:function(e){return"object"===(void 0===e?"undefined":u(e))&&e instanceof Array},isObject:function(e){return"[object Object]"===Object.prototype.toString.call(e)},isObjectEmpty:E,isEmptyString:function(e){return!e||0===e.length},isString:_,isConvertibleToNumber:function(e){return!isNaN(parseFloat(e))&&isFinite(e)},isNumber:m,arrayContains:function(e,t){for(var n=e.length;n--;)if(e[n]===t)return!0;return!1},getDomain:function(e){if(""===e)return"";var t=document.createElement("a");return t.href=e,t.hostname},removeUnsupportedChars:function e(t,n){var r;if("object"!==(void 0===t?"undefined":u(t)))return _(t)?1024<(r=P(t,S)).length&&(r=r.substring(0,1024),n&&n(521,r+"... length exceeded 1024 chars. Trimmed.")):r=t,r;for(var i in t)if(t.hasOwnProperty(i)){var o=e(t[i]),s=_(i)?P(i,I):i;_(i)?1024<(s=P(i,I)).length&&(s=s.substring(0,1024),n&&n(520,s+"... length exceeded 1024 chars. Trimmed.")):s=i,delete t[i],t[s]=o}return t},sanitize:P,isLocalStorageSupported:N,getToday:function(){var e=new Date;return e.getFullYear()+""+e.getMonth()+e.getDay()},getNow:function(){return Math.floor((new Date).getTime()/1e3)},unsupportedKeyCharRegex:I,unsupportedValueCharRegex:S,doubleQuoteRegex:b,singleQuoteRegex:D,readFromStorage:O,saveToStorage:function(e,t){if(e&&(void 0===t?"undefined":u(t))!==s.UNDEFINED&&null!==t)try{N()&&(localStorage[e]=JSON.stringify(t))}catch(e){}},removeFromStorage:function(e){e&&N()&&delete localStorage[e]},setEnum:function(e){if(_(e)||m(e))return"$E_"+e;h.error(c.MESSAGES.enumFormat)},reportError:function(e,t){c.pushError(e,t)},isAnonymousDevice:function(){var e=F.getIdentitiesMapKey(),t=O(e)||{};return E(t)}},k=null,T=function(){function t(){i(this,t)}return o(t,null,[{key:"setGUID",value:function(e){k=e;var t=F.getGUIDKey();null===e?F.remove(t):F.save(t,e)}},{key:"getGUID",value:function(){if(!k){var e=F.getGUIDKey();k=F.read(e)}return k||t.generateGUID(),k}},{key:"generateGUID",value:function(){var e="fx"+function e(t){return t?(t^window.crypto.getRandomValues(new Uint8Array(1))[0]%16>>t/4).toString(16):([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,e)}().replace(/[-]/g,"");A.log.debug("Generating Device ID: "+e),t.setGUID(e)}}]),t}(),w=(new RegExp("^\\s+|\\.|:|\\$|'|\"|\\\\|\\s+$","g"),new RegExp("^\\s+|'|\"|\\\\|\\s+$","g"),new RegExp('"',"g"),new RegExp("'","g"),function(){try{return window.localStorage.setItem("wzrk_debug","12345678"),window.localStorage.removeItem("wzrk_debug"),"localStorage"in window&&null!==window.localStorage}catch(e){return!1}}),C=function(e){if(!e)return null;var t=null;if(w()&&(t=localStorage[e]||null),(void 0===t?"undefined":u(t))!==s.UNDEFINED&&null!==t)try{t=JSON.parse(t)}catch(e){}return t},U=C,R=function(e,t){if(e&&(void 0===t?"undefined":u(t))!==s.UNDEFINED&&null!==t)try{w()&&(localStorage[e]=JSON.stringify(t))}catch(e){}},G=function(e){e&&w()&&delete localStorage[e]},F=function(){function e(){i(this,e)}return o(e,null,[{key:"save",value:function(e,t){e&&t&&R(e,t)}},{key:"read",value:function(e){return e?U(e):null}},{key:"remove",value:function(e){e&&G(e)}},{key:"getGUIDKey",value:function(){var e=d.getAccountId();return e?s.GCOOKIE_NAME+"_"+e:null}},{key:"getSessionKey",value:function(){var e=d.getAccountId(),t=T.getGUID();return e&&t?s.SCOOKIE_PREFIX+"_"+e+"_"+t:null}},{key:"getUserEventsKey",value:function(){var e=d.getAccountId(),t=T.getGUID();return e&&t?s.EV_COOKIE+"_"+e+"_"+t:null}},{key:"getUserProfileKey",value:function(){var e=d.getAccountId(),t=T.getGUID();return e&&t?s.PR_COOKIE+"_"+e+"_"+t:null}},{key:"getSavedEventsKey",value:function(){var e=d.getAccountId(),t=T.getGUID();return e&&t?s.ECOOKIE_PREFIX+"_"+e+"_"+t:null}},{key:"getSavedProfilesKey",value:function(){var e=d.getAccountId(),t=T.getGUID();return e&&t?s.PCOOKIE_PREFIX+"_"+e+"_"+t:null}},{key:"getSavedSequenceNumberKey",value:function(){var e=d.getAccountId();return e?s.SEQCOOKIE_PREFIX+"_"+e:null}},{key:"getARPKey",value:function(){var e=d.getAccountId(),t=T.getGUID();return e&&t?s.ARP_COOKIE+"_"+e+"_"+t:null}},{key:"getMetaKey",value:function(){var e=d.getAccountId(),t=T.getGUID();return e&&t?s.META_COOKIE+"_"+e+"_"+t:null}},{key:"getIdentitiesMapKey",value:function(){var e=d.getAccountId();return e?s.KCOOKIE_NAME+"_"+e:null}},{key:"getChargedIdKey",value:function(){var e=d.getAccountId();return e?s.CHARGED_ID+"_"+e:null}}]),e}(),L=0,M=0,K=0,j=0,V=function(){return F.getSessionKey()},x=function(){function n(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};i(this,n),this.options=e,L=A.getNow();var t=function(){var e=V(),t=F.read(e)||{};return A.isObject(t)||(t={}),t}();M=t.ps||0,f=M<=0,j=t.p||1,K=(t.sc||0)+1,t.ps=L,t.p=j,t.sc=K,function(e){var t=V();F.save(t,e)}(t)}return o(n,[{key:"isFirstSession",value:function(){return f}},{key:"getPageCount",value:function(){return j}},{key:"getTimeElapsed",value:function(){var e=n.getSessionId();return e<=0?0:Math.floor(A.getNow()-e)}},{key:"getTotalVisits",value:function(){return K}},{key:"getLastVisit",value:function(){return 0<M?new Date(1e3*M):0}}],[{key:"getSessionId",value:function(){return L}}]),n}(),q={_f:String.fromCharCode,getKeyStr:function(){var e="",t=0;for(t=0;t<=25;t++)e+=String.fromCharCode(t+65);for(t=0;t<=25;t++)e+=String.fromCharCode(t+97);for(t=0;t<10;t++)e+=t;return e+"+/="},convertToFormattedHex:function(e){var t,n,r,i="";if(!A.isArray(e))return!1;for(n=e.length,t=0;t<n;++t)e[t]<0&&(e[t]=e[t]+256),void 0===e[t]&&(e[t]=0),1===(r=e[t].toString(16)).length&&(r="0"+r),i+=r;return i.trim()},convertStringToHex:function(e){for(var t=[],n=0;n<e.length;n++){var r=e.charCodeAt(n);t.push(255&r),t.push(r>>8&255)}return q.convertToFormattedHex(t)},compressToBase64:function(e){if(null===e)return"";var t,n,r,i,o,s,u,a="",l=0;for(e=q.compress(e);l<2*e.length;)l%2==0?(t=e.charCodeAt(l/2)>>8,n=255&e.charCodeAt(l/2),r=l/2+1<e.length?e.charCodeAt(l/2+1)>>8:NaN):(t=255&e.charCodeAt((l-1)/2),(l+1)/2<e.length?(n=e.charCodeAt((l+1)/2)>>8,r=255&e.charCodeAt((l+1)/2)):n=r=NaN),l+=3,i=t>>2,o=(3&t)<<4|n>>4,s=(15&n)<<2|r>>6,u=63&r,isNaN(n)?s=u=64:isNaN(r)&&(u=64),a=a+q._keyStr.charAt(i)+q._keyStr.charAt(o)+q._keyStr.charAt(s)+q._keyStr.charAt(u);return a},compress:function(e){if(null===e)return"";var t,n,r,i={},o={},s="",u="",a="",l=2,c=3,f=2,v="",d=0,g=0,h=q._f;for(r=0;r<e.length;r+=1)if(s=e.charAt(r),Object.prototype.hasOwnProperty.call(i,s)||(i[s]=c++,o[s]=!0),u=a+s,Object.prototype.hasOwnProperty.call(i,u))a=u;else{if(Object.prototype.hasOwnProperty.call(o,a)){if(a.charCodeAt(0)<256){for(t=0;t<f;t++)d<<=1,15===g?(g=0,v+=h(d),d=0):g++;for(n=a.charCodeAt(0),t=0;t<8;t++)d=d<<1|1&n,15===g?(g=0,v+=h(d),d=0):g++,n>>=1}else{for(n=1,t=0;t<f;t++)d=d<<1|n,15===g?(g=0,v+=h(d),d=0):g++,n=0;for(n=a.charCodeAt(0),t=0;t<16;t++)d=d<<1|1&n,15===g?(g=0,v+=h(d),d=0):g++,n>>=1}0===--l&&(l=Math.pow(2,f),f++),delete o[a]}else for(n=i[a],t=0;t<f;t++)d=d<<1|1&n,15===g?(g=0,v+=h(d),d=0):g++,n>>=1;0===--l&&(l=Math.pow(2,f),f++),i[u]=c++,a=String(s)}if(""!==a){if(Object.prototype.hasOwnProperty.call(o,a)){if(a.charCodeAt(0)<256){for(t=0;t<f;t++)d<<=1,15===g?(g=0,v+=h(d),d=0):g++;for(n=a.charCodeAt(0),t=0;t<8;t++)d=d<<1|1&n,15===g?(g=0,v+=h(d),d=0):g++,n>>=1}else{for(n=1,t=0;t<f;t++)d=d<<1|n,15===g?(g=0,v+=h(d),d=0):g++,n=0;for(n=a.charCodeAt(0),t=0;t<16;t++)d=d<<1|1&n,15===g?(g=0,v+=h(d),d=0):g++,n>>=1}0===--l&&(l=Math.pow(2,f),f++),delete o[a]}else for(n=i[a],t=0;t<f;t++)d=d<<1|1&n,15===g?(g=0,v+=h(d),d=0):g++,n>>=1;0===--l&&(l=Math.pow(2,f),f++)}for(n=2,t=0;t<f;t++)d=d<<1|1&n,15===g?(g=0,v+=h(d),d=0):g++,n>>=1;for(;;){if(d<<=1,15===g){v+=h(d);break}g++}return v}};q._keyStr=q.getKeyStr();var Y,z,B={compressToBase64:q.compressToBase64},$=function(e){return A.log.debug("dobj:"+e),B.compressToBase64(e)},J=function(e){var t={};if(u(e.displayName)!==s.UNDEFINED&&(t.Name=e.displayName),u(e.id)!==s.UNDEFINED&&(t.GPID=e.id+""),u(e.gender)!==s.UNDEFINED&&("male"===e.gender?t.Gender="M":"female"===e.gender?t.Gender="F":"other"===e.gender&&(t.Gender="O")),u(e.image)!==s.UNDEFINED&&(e.image.isDefault||(t.Photo=e.image.url.split("?sz")[0])),u(e.emails)!==s.UNDEFINED)for(var n=0;n<e.emails.length;n++){var r=e.emails[n];"account"===r.type&&(t.Email=r.value)}if(e.organizations){t.Employed="N";for(var i=0;i<e.organizations.length;i++){if("work"===e.organizations[i].type){t.Employed="Y";break}}}if(e.birthday){var o=e.birthday.split("-");t.DOB=A.setDate(o[0]+o[1]+o[2])}return e.relationshipStatus&&(t.Married="N","married"===e.relationshipStatus&&(t.Married="Y")),A.log.debug("gplus usr profile "+JSON.stringify(t)),t},Q=function(e){var t={};t.Name=e.name,e.id&&(t.FBID=e.id+""),"male"===e.gender?t.Gender="M":"female"===e.gender?t.Gender="F":t.Gender="O";e.relationship_status&&(t.Married="N","Married"===e.relationship_status&&(t.Married="Y"));var n=function(e){if(e){for(var t="",n="",r=0;r<e.length;r++){var i=e[r];if(i.type){var o=i.type;if("Graduate School"===o)return"Graduate";"College"===o?t="1":"High School"===o&&(n="1")}}if("1"===t)return"College";if("1"===n)return"School"}}(e.education);if(n&&(t.Education=n),t.Employed=e.work?"Y":"N",e.email&&(t.Email=e.email),e.birthday){var r=e.birthday.split("/");t.DOB=A.setDate(r[2]+r[0]+r[1])}return t},H=void 0,X=function(e){if(A.isObject(e)){for(var t in e)if(e.hasOwnProperty(t)){if(A.isObject(e[t])||A.isArray(e[t]))return!1;A.isDateObject(e[t])&&(e[t]=A.convertToWZRKDate(e[t]))}return!0}return!1},W=X,Z=function(e){var t=!0;if(A.isObject(e))for(var n in e)if(e.hasOwnProperty(n)){var r=e[n];if((void 0===r?"undefined":u(r))===s.UNDEFINED){delete e[n];continue}"Gender"!==n||r.match(/^M$|^F$/)||(t=!1,A.log.error(c.MESSAGES.gender)),"Employed"!==n||r.match(/^Y$|^N$/)||(t=!1,A.log.error(c.MESSAGES.employed)),"Married"!==n||r.match(/^Y$|^N$/)||(t=!1,A.log.error(c.MESSAGES.married)),"Education"!==n||r.match(/^School$|^College$|^Graduate$/)||(t=!1,A.log.error(c.MESSAGES.education)),"Age"===n&&(void 0===r?"undefined":u(r))!==s.UNDEFINED&&(A.isConvertibleToNumber(r)?e.Age=+r:(t=!1,A.log.error(c.MESSAGES.age))),"DOB"===n&&(/^\$D_/.test(r)&&11===(r+"").length||A.isDateObject(r)||(t=!1,A.log.error(c.MESSAGES.dob))),A.isDateObject(r)&&(e[n]=A.convertToWZRKDate(r)),"Phone"!==n||A.isObjectEmpty(r)||(8<r.length&&"+"===r.charAt(0)?(r=r.substring(1,r.length),A.isConvertibleToNumber(r)?e.Phone=+r:(t=!1,A.log.error(c.MESSAGES.phoneFormat+". Removed."))):(t=!1,A.log.error(c.MESSAGES.phoneFormat+". Removed."))),t||delete e[n]}return t},ee=function(e,t){if(A.isObject(e)){for(var n in e)if(e.hasOwnProperty(n))if("Items"===n){if(!A.isArray(e[n]))return!1;for(var r in 16<e[n].length&&t&&t(522,"Charged Items exceed 16 limit. Actual count: "+e[n].length+". Additional items will be dropped."),e[n])if(e[n].hasOwnProperty(r)&&(!A.isObject(e[n][r])||!X(e[n][r])))return!1}else{if(A.isObject(e[n])||A.isArray(e[n]))return!1;A.isDateObject(e[n])&&(e[n]=A.convertToWZRKDate(e[n]))}if(u(e[s.CHARGED_ID])!==s.UNDEFINED){var i=e[s.CHARGED_ID],o=F.getChargedIdKey();if((void 0===H?"undefined":u(H))===s.UNDEFINED&&(H=F.read(o)),(void 0===H?"undefined":u(H))!==s.UNDEFINED&&H===i)return A.log.error("Duplicate charged Id - Dropped"+e),!1;H=i,F.save(o,i)}return!0}return!1},te=[],ne=function(){function r(e,t){if(i(this,r),this.api=e,te.push=function(e){var t=r.generateProfileObj(e),n=r.generateProfileEvent(t);this.api.processEvent(n)}.bind(this),t&&0<t.length)for(var n=0;n<t.length;n++)this.push(t[n])}return o(r,[{key:"push",value:function(){return te.push(Array.prototype.slice.call(arguments)),!0}},{key:"getAttribute",value:function(e){return this.api.getProfileAttribute(e)}}],[{key:"getCachedGUIDForIdentity",value:function(e,t){if(!e||!t)return null;var n=F.getIdentitiesMapKey();return n&&(F.read(n)||{})[e+"_"+t]||null}},{key:"extractIdentifiersFromProfileObj",value:function(e){if(!e||A.isObjectEmpty(e))return null;var t=[];return e.Email&&t.push({type:s.IDENTITY_TYPES.EMAIL,id:e.Email}),e.GPID&&t.push({type:s.IDENTITY_TYPES.GPID,id:e.GPID}),e.FBID&&t.push({type:s.IDENTITY_TYPES.FBID,id:e.FBID}),e.Identity&&t.push({type:s.IDENTITY_TYPES.IDENTITY,id:e.Identity}),t}},{key:"generateProfileObj",value:function(e){var t;if(!A.isArray(e)||e.length<=0)return null;for(var n=0;n<e.length;n++){var r=e[n];if(t=null,r.Site){if(t=r.Site,A.isObjectEmpty(t)||!Z(t))return null}else if(r.Facebook){var i=r.Facebook;A.isObjectEmpty(i)||i.error||(t=Q(i))}else if(r["Google Plus"]){var o=r["Google Plus"];A.isObjectEmpty(o)||o.error||(t=J(o))}if(t&&!A.isObjectEmpty(t)){t.tz||(t.tz=(new Date).toString().match(/([A-Z]+[\+-][0-9]+)/)[1]);break}}return t}},{key:"generateProfileEvent",value:function(e){if(!e||A.isObjectEmpty(e))return null;var t=r.extractIdentifiersFromProfileObj(e);return 0<t.length&&function(e){var t=F.getIdentitiesMapKey(),n=T.getGUID();if(n&&e&&!(e.length<=0)){for(var r=F.read(t)||{},i=0;i<e.length;i++){var o=e[i];o.type&&o.id&&(r[o.type+"_"+o.id]=n)}F.save(t,r)}}(t),{ep:A.getNow(),type:s.EVENT_TYPES.PROFILE,profile:e}}}]),r}(),re=function(){function n(e,t){i(this,n),this.url=e,this.data=t||[]}return o(n,[{key:"send",value:function(e){var t=new XMLHttpRequest({mozSystem:!0});t.open("post",this.url,!0),t.responseType="json",t.addEventListener("error",function(){e&&e(t.status,t.error)}),t.addEventListener("load",function(){e&&e(t.status,t.response)}),t.setRequestHeader("Accept","application/json"),t.setRequestHeader("Content-Type","application/json"),t.send(JSON.stringify(this.data)),A.log.debug("req snt -> url: "+this.url)}}]),n}(),ie=function(e){var t=F.read(e);return A.isArray(t)?t:[]},oe=function(){return F.getSavedEventsKey()},se=function(){return F.getSavedProfilesKey()},ue=function(){return F.getSavedSequenceNumberKey()},ae=function(){return F.getARPKey()},le=function(){function t(e){i(this,t),this.options=e,this.options.eventUploadRetryInterval=this.options.eventUploadInterval,this._uploading=!1,this._requestScheduled=!1,this._unsentEvents=ie(oe()),this._unsentProfiles=ie(se()),this._sequenceNumber=function(e){var t=F.read(e)||0;return parseInt(t,10)}(ue()),this._scheduleEvents()}return o(t,[{key:"clearEvents",value:function(e){var t=this;this._sendEvents(function(){t._unsentEvents=[],t._unsentProfiles=[],t._saveEvents(),e()})}},{key:"queueEvent",value:function(e){e&&(e._seq=this._nextSequenceNumber(),A.log.debug("Queuing event "+JSON.stringify(e)),e.type===s.EVENT_TYPES.PROFILE?this._unsentProfiles.push(e):this._unsentEvents.push(e),this._saveEvents(),this._scheduleEvents())}},{key:"_getEndPoint",value:function(){var e=this.options.domain;return d.getRegion()&&(e=d.getRegion()+"."+this.options.domain),this.options.protocol+"//"+e+"/a2?t=77"}},{key:"_unsentCount",value:function(){return this._unsentEvents.length+this._unsentProfiles.length}},{key:"_scheduleRetry",value:function(){this.options.eventUploadRetryInterval=2*this.options.eventUploadRetryInterval,this._scheduleEvents(null,!0)}},{key:"_scheduleEvents",value:function(e,t){if(0===this._unsentCount())return A.log.debug("No events in the queue, not scheduling an event update"),!1;if(this._unsentCount()>=this.options.eventUploadThreshold)return this._sendEvents(e),!0;if(this._requestScheduled)return A.log.debug("Event upload already scheduled"),!1;this._requestScheduled=!0;var n=t?this.options.eventUploadRetryInterval:this.options.eventUploadInterval;return setTimeout(function(){this._requestScheduled=!1,this._sendEvents(e)}.bind(this),n),A.log.debug("Scheduling an event upload in "+n/1e3+" seconds"),!1}},{key:"_sendEvents",value:function(n){var e=!1,t="";if(this._uploading&&(e=!0,t="Already Uploading"),this._unsentCount()<=0&&(e=!0,t="No events in the queue"),e){var r="Skipping events upload: "+t;return A.log.debug(r),void("function"==typeof n&&n(0,r))}this._uploading=!0;var i=this._getEndPoint();i=this._addToURL(i,"sn",A.getNow()),i=this._addARPToRequest(i),i=this._addToURL(i,"r",(new Date).getTime());var o={id:d.getAccountId(),"SDK Version":1e4,s:""+x.getSessionId()};d.getAppVersion()&&(o.Version=""+d.getAppVersion());var s=T.getGUID();s&&(i=this._addToURL(i,"gc",s),o.g=s),i=this._addToURL(i,"d",$(JSON.stringify(o)));var u=Math.min(this._unsentCount(),this.options.uploadBatchSize),a=this._mergeEventQueues(u),l=a.maxEventId,c=a.maxProfilesId,f=a.eventsToSend;A.log.debug("Sending events: "+JSON.stringify(f));var v=this;new re(i,f).send(function(e,t){v._uploading=!1,t=t||{},A.log.debug("handling response with status: "+e+" and data: "+JSON.stringify(t));try{200===e?(t.g&&T.setGUID(t.g),v._removeEvents(l,c),v._saveEvents(),v._updateARP(t),v._scheduleEvents(n)||"function"!=typeof n||n(e,t)):413===e?(A.log.error("event upload request too large"),1===v.options.uploadBatchSize&&v._removeEvents(l,c),v.options.uploadBatchSize=Math.ceil(u/2),v._sendEvents(n)):(A.log.error("Events upload failed with status "+e+".  Will retry."),v._scheduleRetry(),"function"==typeof n&&n(e,t))}catch(e){v._uploading=!1,A.log.error("Events upload failed: "+e.message+".  Will retry."),v._scheduleRetry()}})}},{key:"_saveEvents",value:function(){F.save(oe(),this._unsentEvents),F.save(se(),this._unsentProfiles)}},{key:"_trimEventsQueued",value:function(e){e.length>this.options.maxSavedEventCount&&e.splice(0,e.length-this.options.maxSavedEventCount)}},{key:"_removeEvents",value:function(e,t){this._removeEventsFromQueue("_unsentEvents",e),this._removeEventsFromQueue("_unsentProfiles",t)}},{key:"_removeEventsFromQueue",value:function(e,t){if(!(t<0)){for(var n=[],r=0;r<this[e].length;r++)this[e][r]._seq>t&&n.push(this[e][r]);this[e]=n}}},{key:"_nextSequenceNumber",value:function(){return this._sequenceNumber++,F.save(ue(),this._sequenceNumber),this._sequenceNumber}},{key:"_mergeEventQueues",value:function(e){for(var t=[],n=0,r=-1,i=0,o=-1;t.length<e;){var s,u=i>=this._unsentProfiles.length,a=n>=this._unsentEvents.length;if(a&&u){A.log.error("Problem merging event queues, fewer events than expected");break}u?r=(s=this._unsentEvents[n++])._seq:a?o=(s=this._unsentProfiles[i++])._seq:this._unsentEvents[n]._seq<this._unsentProfiles[i]._seq?r=(s=this._unsentEvents[n++])._seq:o=(s=this._unsentProfiles[i++])._seq,t.push(s)}return{eventsToSend:t,maxEventId:r,maxProfilesId:o}}},{key:"_updateARP",value:function(){var e=(0<arguments.length&&void 0!==arguments[0]?arguments[0]:{}).arp;if(e){var t=ae();try{var n=F.read(t)||{};for(var r in e)e.hasOwnProperty(r)&&(-1===e[r]?delete n[r]:n[r]=e[r]);F.save(t,n)}catch(e){A.log.error("Unable to parse ARP JSON: "+e)}}}},{key:"_addARPToRequest",value:function(e){var t=ae();if(!t)return e;var n=F.read(t);return n?this._addToURL(e,"arp",$(JSON.stringify(n))):e}},{key:"_addToURL",value:function(e,t,n){return e+"&"+t+"="+encodeURIComponent(n)}}]),t}(),ce=function(e,t){var n={type:e,ep:A.getNow()};t&&t(n)},fe=function(){function t(e){i(this,t),this.options=e,this.queueManager=new le(Object.assign({},this.options)),this._newSession()}return o(t,[{key:"getCleverTapID",value:function(){return T.getGUID()}},{key:"getTimeElapsed",value:function(){return this._isPersonalizationActive()?this.session.getTimeElapsed():0}},{key:"getPageCount",value:function(){return this._isPersonalizationActive()?this.session.getPageCount():0}},{key:"getTotalVisits",value:function(){return this._isPersonalizationActive()?this.session.getTotalVisits():0}},{key:"getLastVisit",value:function(){return this._isPersonalizationActive()?this.session.getLastVisit():0}},{key:"getEventDetails",value:function(e){if(this._isPersonalizationActive()){var t=this._getEventsMap()[e];if(!t)return null;var n={};return n.firstTime=new Date(1e3*t[1]),n.lastTime=new Date(1e3*t[2]),n.count=t[0],n}}},{key:"getProfileAttribute",value:function(e){if(this._isPersonalizationActive())return this._getProfilesMap()[e]}},{key:"processEvent",value:function(e){A.isObject(e)&&(e.type===s.EVENT_TYPES.EVENT&&this._addToLocalEventMap(e.evtName),e.type===s.EVENT_TYPES.PROFILE&&this._addToLocalProfileMap(e.profile),e=this._addSystemDataToObject(e,void 0),this.queueManager.queueEvent(e))}},{key:"onUserLogin",value:function(e){var t=this,n=ne.generateProfileObj(e),r=T.getGUID();if(r&&n){for(var i,o=ne.extractIdentifiersFromProfileObj(n)||[],s=0<o.length,u=0;u<o.length;u++){var a=o[u];if(a.type&&a.id&&(i=ne.getCachedGUIDForIdentity(a.type,a.id)))break}return!s||A.isAnonymousDevice()?(A.log.debug("onUserLogin: either don't have identifier or device is anonymous, associating profile "+JSON.stringify(n)+" with current user profile"),void this._processProfileEvent(n)):i&&i===r?(A.log.debug("onUserLogin: profile "+JSON.stringify(n)+" maps to current device id "+r+", using current user profile"),void this._processProfileEvent(n)):void(this.processingUserLogin?A.log.debug("Already processing onUserLogin for "+this.processingUserLoginKey+" , will not process for profile: "+JSON.stringify(n)):(this.processingUserLogin=!0,this.processingUserLoginKey=JSON.stringify(n),A.log.debug("Processing onUserLogin for "+this.processingUserLoginKey),this.queueManager.clearEvents(function(){i?T.setGUID(i):T.generateGUID(),t._clearDataMaps(),t._newSession(),t._processProfileEvent(n),t.processingUserLogin=!1,t.processingUserLoginKey=null})))}}},{key:"_newSession",value:function(){this.session=new x(Object.assign({},this.options)),this._generateLaunchEvents()}},{key:"_generateLaunchEvents",value:function(){var t=this;!function(t){ce(s.EVENT_TYPES.EVENT,function(e){e.evtName=s.APP_LAUNCHED,e.evtData={"SDK Version":1e4},d.getAppVersion()&&(e.evtData.Version=""+d.getAppVersion()),t&&t(e)})}(function(e){t.processEvent(e)}),this.options.sendPages&&ce(s.EVENT_TYPES.PAGE,function(e){t.processEvent(e)})}},{key:"_getEventsMap",value:function(){if(!Y){var e=F.getUserEventsKey();Y=F.read(e)||{}}return Y}},{key:"_getProfilesMap",value:function(){if(!z){var e=F.getUserProfileKey();z=F.read(e)||{}}return z}},{key:"_clearDataMaps",value:function(){z=Y=null}},{key:"_startPings",value:function(){if(this.options.sendPings){var t=this;setInterval(function(){ce(s.EVENT_TYPES.PING,function(e){t.processEvent(e)})},s.PING_FREQ_IN_MILLIS)}}},{key:"_isPersonalizationActive",value:function(){return this.options.enablePersonalization}},{key:"_processProfileEvent",value:function(e){var t=ne.generateProfileEvent(e);this.processEvent(t)}},{key:"_addToLocalEventMap",value:function(e){if(e){var t=this._getEventsMap(),n=A.getNow(),r=t[e];r?(r[2]=n,r[0]++):((r=[]).push(1),r.push(n),r.push(n)),t[e]=r;var i=F.getUserEventsKey();F.save(i,t)}}},{key:"_addToLocalProfileMap",value:function(e){if(e){var t=this._getProfilesMap();if(e._custom){var n=e._custom;for(var r in n)n.hasOwnProperty(r)&&(e[r]=n[r]);delete e._custom}for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);t._custom&&delete t._custom;var o=F.getUserProfileKey();F.save(o,t)}}},{key:"_addSystemDataToObject",value:function(e,t){t||(e=A.removeUnsupportedChars(e,function(e,t){A.reportError(e,t)}));var n=c.popError();return n&&(e.wzrk_error=n),e.id=d.getAccountId(),T.getGUID()&&(e.g=T.getGUID()),e.s=x.getSessionId(),e.pg=this.session.getPageCount(),e.f=this.session.isFirstSession(),e}}]),t}(),ve=[],de=function(){function r(e,t){if(i(this,r),this.api=e,ve.push=function(e){var t=function(e){if(A.isArray(e)){for(var t=null;0<e.length;){var n=e.shift();if(!A.isString(n))return void A.log.error(c.MESSAGES.event);if(1024<n.length&&(n=n.substring(0,1024),A.reportError(510,n+"... length exceeded 1024 chars. Trimmed.")),"Stayed"!==n&&"UTM Visited"!==n&&"App Launched"!==n&&"Notification Sent"!==n&&"Notification Viewed"!==n&&"Notification Clicked"!==n){if(t={type:s.EVENT_TYPES.EVENT,ep:A.getNow(),evtName:A.sanitize(n,A.unsupportedKeyCharRegex)},0!==e.length){var r=e.shift();if(A.isObject(r)){if("Charged"===n){ee(r),A.reportError(511,"Charged event structure invalid. Not sent.");continue}if(!W(r)){A.reportError(512,n+" event structure invalid. Not sent.");continue}t.evtData=r}else e.unshift(r)}}else A.reportError(513,n+" is a restricted system event. It cannot be used as an event name.")}return t}}(e);this.api.processEvent(t)}.bind(this),t&&0<t.length)for(var n=0;n<t.length;n++)this.push(t[n])}return o(r,[{key:"push",value:function(){return ve.push(Array.prototype.slice.call(arguments)),!0}},{key:"getDetails",value:function(e){return this.api.getEventDetails(e)}}]),r}(),ge={domain:"wzrkt.com",protocol:"https:",enablePersonalization:!0,eventUploadInterval:1e3,eventUploadThreshold:50,maxSavedEventCount:1e3,uploadBatchSize:50,sendPages:!1,sendPings:!1},he=function(){function t(e){i(this,t),this.api=e}return o(t,[{key:"getTimeElapsed",value:function(){return this.api.getTimeElapsed()}},{key:"getPageCount",value:function(){return this.api.getPageCount()}}]),t}(),pe=function(){function t(e){i(this,t),this.api=e}return o(t,[{key:"getTotalVisits",value:function(){return this.api.getTotalVisits()}},{key:"getLastVisit",value:function(){return this.api.getLastVisit()}}]),t}(),ye=[],Ee=function(){function r(e,t){if(i(this,r),this.api=e,ye.push=function(e){this.api.onUserLogin(e)}.bind(this),t&&0<t.length)for(var n=0;n<t.length;n++)this.push(t[n])}return o(r,[{key:"push",value:function(){return ye.push(Array.prototype.slice.call(arguments)),!0}}]),r}();return new(function(){function t(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};i(this,t),this.options=Object.assign({},ge),this.event=e.event||[],this.profile=e.profile||[],this.onUserLogin=e.onUserLogin||[],this.logLevels=A.logLevels}return o(t,[{key:"init",value:function(e,t){A.isEmptyString(e)?A.log.error(c.MESSAGES.init):(d.setAccountId(e),d.setRegion(t),this.api=new fe(Object.assign({},this.options)),this.session=new he(this.api),this.user=new pe(this.api),this.onUserLogin=new Ee(this.api,this.onUserLogin),this.event=new de(this.api,this.event),this.profile=new ne(this.api,this.profile))}},{key:"getCleverTapID",value:function(){return this.api.getCleverTapID()}},{key:"setLogLevel",value:function(e){A.setLogLevel(e)}},{key:"getLogLevel",value:function(){return A.getLogLevel()}},{key:"setAppVersion",value:function(e){d.setAppVersion(e)}},{key:"getAppVersion",value:function(){return d.getAppVersion()}}]),t}())(window.clevertap)});
