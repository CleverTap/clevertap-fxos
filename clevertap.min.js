!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.clevertap=t()}(this,function(){"use strict";var e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},t=(function(){function e(e){this.value=e}function t(t){function n(i,o){try{var s=t[i](o),u=s.value;u instanceof e?Promise.resolve(u.value).then(function(e){n("next",e)},function(e){n("throw",e)}):r(s.done?"return":"normal",s.value)}catch(e){r("throw",e)}}function r(e,t){switch(e){case"return":i.resolve({value:t,done:!0});break;case"throw":i.reject(t);break;default:i.resolve({value:t,done:!1})}(i=i.next)?n(i.key,i.arg):o=null}var i,o;this._invoke=function(e,t){return new Promise(function(r,s){var u={key:e,arg:t,resolve:r,reject:s,next:null};o?o=o.next=u:(i=o=u,n(e,t))})},"function"!=typeof t.return&&(this.return=void 0)}"function"==typeof Symbol&&Symbol.asyncIterator&&(t.prototype[Symbol.asyncIterator]=function(){return this}),t.prototype.next=function(e){return this._invoke("next",e)},t.prototype.throw=function(e){return this._invoke("throw",e)},t.prototype.return=function(e){return this._invoke("return",e)}}(),function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}),n=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),r=null,i=null,o=function(){function e(){t(this,e)}return n(e,null,[{key:"setAccountId",value:function(e){r=e}},{key:"getAccountId",value:function(){return r}},{key:"setRegion",value:function(e){i=e}},{key:"getRegion",value:function(){return i}}]),e}(),s="chargedId",u="CT_E",a="CT_G",l="CT_K",c="CT_P",f="CT_SEQ",d="CT_S",v="CT_EV",g="CT_META",h="CT_PR",p="CT_ARP",y="undefined",m=12e4,E={EVENT:"event",PROFILE:"profile",PAGE:"page",PING:"ping"},_="App Launched",S={IDENTITY:"Identity",EMAIL:"Email",FBID:"FBID",GPID:"GPID"},b="This property has been ignored.",k={init:"Invalid account id",event:"Event structure not valid. Unable to process event",gender:"Gender value should be either M or F. "+b,employed:"Employed value should be either Y or N. "+b,married:"Married value should be either Y or N. "+b,education:"Education value should be either School, College or Graduate. "+b,age:"Age value should be a number. "+b,dob:"DOB value should be a Date Object",objArr:"Expecting Object array in profile",dateFormat:"setDate(number). number should be formatted as yyyymmdd",enumFormat:"setEnum(value). value should be a string or a number",phoneFormat:"Phone number should be formatted as +[country code][number]"},I=[],P=function(){function e(){t(this,e)}return n(e,null,[{key:"pushError",value:function(e,t){I.push({c:e,d:t})}},{key:"popError",value:function(){return I.shift()}}]),e}();P.MESSAGES=k;var w,D={DISABLE:0,ERROR:1,INFO:2,DEBUG:3},A=D.INFO,O={error:function(e){A>=D.ERROR&&N("error",e)},info:function(e){A>=D.INFO&&N("log",e)},debug:function(e){A>=D.DEBUG&&N("debug",e)}},N=function(e,t){if(window.console)try{var n=(new Date).getTime();console[e]("CleverTap ["+n+"]: "+t)}catch(e){}},T=function(e){var t=/^(\d{4})(\d{2})(\d{2})$/.exec(e);if(null===t)return!1;var n=t[3],r=t[2]-1,i=t[1],o=new Date(i,r,n);return o.getDate()===n&&o.getMonth()===r&&o.getFullYear()===i},U=function(e){for(var t in e)if(e.hasOwnProperty(t))return!1;return!0},C=function(e){return"string"==typeof e||e instanceof String},G=function(e){return/^-?[\d.]+(?:e-?\d+)?$/.test(e)&&"number"==typeof e},R=new RegExp("^\\s+|\\.|:|\\$|'|\"|\\\\|\\s+$","g"),L=new RegExp("^\\s+|'|\"|\\\\|\\s+$","g"),M=new RegExp('"',"g"),j=new RegExp("'","g"),q=function(e,t){return e.replace(t,"")},x=function(){try{return window.localStorage.setItem("wzrk_debug","12345678"),window.localStorage.removeItem("wzrk_debug"),"localStorage"in window&&null!==window.localStorage}catch(e){return!1}},F=function(t){if(!t)return null;var n=null;if(x()&&(n=localStorage[t]||null),(void 0===n?"undefined":e(n))!==y&&null!==n)try{n=JSON.parse(n)}catch(e){}return n},K={logLevels:D,setLogLevel:function(e){A=e},getLogLevel:function(){return A},log:O,setDate:function(e){if(T(e))return"$D_"+e;O.error(P.MESSAGES.dateFormat)},isDateObject:function(t){return"object"===(void 0===t?"undefined":e(t))&&t instanceof Date},convertToWZRKDate:function(e){return"$D_"+Math.round(e.getTime()/1e3)},isDateValid:T,isArray:function(t){return"object"===(void 0===t?"undefined":e(t))&&t instanceof Array},isObject:function(e){return"[object Object]"===Object.prototype.toString.call(e)},isObjectEmpty:U,isEmptyString:function(e){return!e||0===e.length},isString:C,isConvertibleToNumber:function(e){return!isNaN(parseFloat(e))&&isFinite(e)},isNumber:G,arrayContains:function(e,t){for(var n=e.length;n--;)if(e[n]===t)return!0;return!1},getDomain:function(e){if(""===e)return"";var t=document.createElement("a");return t.href=e,t.hostname},removeUnsupportedChars:function t(n,r){if("object"!==(void 0===n?"undefined":e(n))){var i;return C(n)?(i=q(n,L)).length>1024&&(i=i.substring(0,1024),r&&r(521,i+"... length exceeded 1024 chars. Trimmed.")):i=n,i}for(var o in n)if(n.hasOwnProperty(o)){var s=t(n[o]),u=C(o)?q(o,R):o;C(o)?(u=q(o,R)).length>1024&&(u=u.substring(0,1024),r&&r(520,u+"... length exceeded 1024 chars. Trimmed.")):u=o,delete n[o],n[u]=s}return n},sanitize:q,isLocalStorageSupported:x,getToday:function(){var e=new Date;return e.getFullYear()+""+e.getMonth()+e.getDay()},getNow:function(){return Math.floor((new Date).getTime()/1e3)},unsupportedKeyCharRegex:R,unsupportedValueCharRegex:L,doubleQuoteRegex:M,singleQuoteRegex:j,readFromStorage:F,saveToStorage:function(t,n){if(t&&(void 0===n?"undefined":e(n))!==y&&null!==n)try{x()&&(localStorage[t]=JSON.stringify(n))}catch(e){}},removeFromStorage:function(e){e&&x()&&delete localStorage[e]},setEnum:function(e){if(C(e)||G(e))return"$E_"+e;O.error(P.MESSAGES.enumFormat)},reportError:function(e,t){P.pushError(e,t)},isAnonymousDevice:function(){var e=H.getIdentitiesMapKey(),t=F(e)||{};return U(t)}},z=null,V=function(){function e(){t(this,e)}return n(e,null,[{key:"setGUID",value:function(e){z=e;var t=H.getGUIDKey();null===e?H.remove(t):H.save(t,e)}},{key:"getGUID",value:function(){if(!z){var t=H.getGUIDKey();z=H.read(t)}return z||e.generateGUID(),z}},{key:"generateGUID",value:function(){var t="fx"+function e(t){return t?(t^window.crypto.getRandomValues(new Uint8Array(1))[0]%16>>t/4).toString(16):([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,e)}().replace(/[-]/g,"");K.log.debug("Generating Device ID: "+t),e.setGUID(t)}}]),e}(),B=(new RegExp("^\\s+|\\.|:|\\$|'|\"|\\\\|\\s+$","g"),new RegExp("^\\s+|'|\"|\\\\|\\s+$","g"),new RegExp('"',"g"),new RegExp("'","g"),function(){try{return window.localStorage.setItem("wzrk_debug","12345678"),window.localStorage.removeItem("wzrk_debug"),"localStorage"in window&&null!==window.localStorage}catch(e){return!1}}),$=function(t){if(!t)return null;var n=null;if(B()&&(n=localStorage[t]||null),(void 0===n?"undefined":e(n))!==y&&null!==n)try{n=JSON.parse(n)}catch(e){}return n},J=$,Q=function(t,n){if(t&&(void 0===n?"undefined":e(n))!==y&&null!==n)try{B()&&(localStorage[t]=JSON.stringify(n))}catch(e){}},Y=function(e){e&&B()&&delete localStorage[e]},H=function(){function e(){t(this,e)}return n(e,null,[{key:"save",value:function(e,t){e&&t&&Q(e,t)}},{key:"read",value:function(e){return e?J(e):null}},{key:"remove",value:function(e){e&&Y(e)}},{key:"getGUIDKey",value:function(){var e=o.getAccountId();return e?a+"_"+e:null}},{key:"getSessionKey",value:function(){var e=o.getAccountId(),t=V.getGUID();return e&&t?d+"_"+e+"_"+t:null}},{key:"getUserEventsKey",value:function(){var e=o.getAccountId(),t=V.getGUID();return e&&t?v+"_"+e+"_"+t:null}},{key:"getUserProfileKey",value:function(){var e=o.getAccountId(),t=V.getGUID();return e&&t?h+"_"+e+"_"+t:null}},{key:"getSavedEventsKey",value:function(){var e=o.getAccountId(),t=V.getGUID();return e&&t?u+"_"+e+"_"+t:null}},{key:"getSavedProfilesKey",value:function(){var e=o.getAccountId(),t=V.getGUID();return e&&t?c+"_"+e+"_"+t:null}},{key:"getSavedSequenceNumberKey",value:function(){var e=o.getAccountId();return e?f+"_"+e:null}},{key:"getARPKey",value:function(){var e=o.getAccountId(),t=V.getGUID();return e&&t?p+"_"+e+"_"+t:null}},{key:"getMetaKey",value:function(){var e=o.getAccountId(),t=V.getGUID();return e&&t?g+"_"+e+"_"+t:null}},{key:"getIdentitiesMapKey",value:function(){var e=o.getAccountId();return e?l+"_"+e:null}},{key:"getChargedIdKey",value:function(){var e=o.getAccountId();return e?s+"_"+e:null}}]),e}(),Z=0,W=0,X=0,ee=0,te=function(){return H.getSessionKey()},ne=function(){var e=te(),t=H.read(e)||{};return K.isObject(t)||(t={}),t},re=function(e){var t=te();H.save(t,e)},ie=function(){function e(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};t(this,e),this.options=n,Z=K.getNow();var r=ne();W=r.ps||0,w=W<=0,ee=r.p||1,X=(r.sc||0)+1,r.ps=Z,r.p=ee,r.sc=X,re(r)}return n(e,[{key:"isFirstSession",value:function(){return w}},{key:"getPageCount",value:function(){return ee}},{key:"getTimeElapsed",value:function(){var t=e.getSessionId();return t<=0?0:Math.floor(K.getNow()-t)}},{key:"getTotalVisits",value:function(){return X}},{key:"getLastVisit",value:function(){return W>0?new Date(1e3*W):0}}],[{key:"getSessionId",value:function(){return Z}}]),e}(),oe={_f:String.fromCharCode,getKeyStr:function(){var e="",t=0;for(t=0;t<=25;t++)e+=String.fromCharCode(t+65);for(t=0;t<=25;t++)e+=String.fromCharCode(t+97);for(t=0;t<10;t++)e+=t;return e+"+/="},convertToFormattedHex:function(e){var t,n,r,i="";if(!K.isArray(e))return!1;for(n=e.length,t=0;t<n;++t)e[t]<0&&(e[t]=e[t]+256),void 0===e[t]&&(e[t]=0),1===(r=e[t].toString(16)).length&&(r="0"+r),i+=r;return i.trim()},convertStringToHex:function(e){for(var t=[],n=0;n<e.length;n++){var r=e.charCodeAt(n);t.push(255&r),t.push(r>>8&255)}return oe.convertToFormattedHex(t)},compressToBase64:function(e){if(null===e)return"";var t,n,r,i,o,s,u,a="",l=0;for(e=oe.compress(e);l<2*e.length;)l%2==0?(t=e.charCodeAt(l/2)>>8,n=255&e.charCodeAt(l/2),r=l/2+1<e.length?e.charCodeAt(l/2+1)>>8:NaN):(t=255&e.charCodeAt((l-1)/2),(l+1)/2<e.length?(n=e.charCodeAt((l+1)/2)>>8,r=255&e.charCodeAt((l+1)/2)):n=r=NaN),l+=3,i=t>>2,o=(3&t)<<4|n>>4,s=(15&n)<<2|r>>6,u=63&r,isNaN(n)?s=u=64:isNaN(r)&&(u=64),a=a+oe._keyStr.charAt(i)+oe._keyStr.charAt(o)+oe._keyStr.charAt(s)+oe._keyStr.charAt(u);return a},compress:function(e){if(null===e)return"";var t,n,r,i={},o={},s="",u="",a="",l=2,c=3,f=2,d="",v=0,g=0,h=oe._f;for(r=0;r<e.length;r+=1)if(s=e.charAt(r),Object.prototype.hasOwnProperty.call(i,s)||(i[s]=c++,o[s]=!0),u=a+s,Object.prototype.hasOwnProperty.call(i,u))a=u;else{if(Object.prototype.hasOwnProperty.call(o,a)){if(a.charCodeAt(0)<256){for(t=0;t<f;t++)v<<=1,15===g?(g=0,d+=h(v),v=0):g++;for(n=a.charCodeAt(0),t=0;t<8;t++)v=v<<1|1&n,15===g?(g=0,d+=h(v),v=0):g++,n>>=1}else{for(n=1,t=0;t<f;t++)v=v<<1|n,15===g?(g=0,d+=h(v),v=0):g++,n=0;for(n=a.charCodeAt(0),t=0;t<16;t++)v=v<<1|1&n,15===g?(g=0,d+=h(v),v=0):g++,n>>=1}0===--l&&(l=Math.pow(2,f),f++),delete o[a]}else for(n=i[a],t=0;t<f;t++)v=v<<1|1&n,15===g?(g=0,d+=h(v),v=0):g++,n>>=1;0===--l&&(l=Math.pow(2,f),f++),i[u]=c++,a=String(s)}if(""!==a){if(Object.prototype.hasOwnProperty.call(o,a)){if(a.charCodeAt(0)<256){for(t=0;t<f;t++)v<<=1,15===g?(g=0,d+=h(v),v=0):g++;for(n=a.charCodeAt(0),t=0;t<8;t++)v=v<<1|1&n,15===g?(g=0,d+=h(v),v=0):g++,n>>=1}else{for(n=1,t=0;t<f;t++)v=v<<1|n,15===g?(g=0,d+=h(v),v=0):g++,n=0;for(n=a.charCodeAt(0),t=0;t<16;t++)v=v<<1|1&n,15===g?(g=0,d+=h(v),v=0):g++,n>>=1}0===--l&&(l=Math.pow(2,f),f++),delete o[a]}else for(n=i[a],t=0;t<f;t++)v=v<<1|1&n,15===g?(g=0,d+=h(v),v=0):g++,n>>=1;0===--l&&(l=Math.pow(2,f),f++)}for(n=2,t=0;t<f;t++)v=v<<1|1&n,15===g?(g=0,d+=h(v),v=0):g++,n>>=1;for(;;){if(v<<=1,15===g){d+=h(v);break}g++}return d}};oe._keyStr=oe.getKeyStr();var se,ue,ae={compressToBase64:oe.compressToBase64},le=function(e){return K.log.debug("dobj:"+e),ae.compressToBase64(e)},ce=function(t){var n={};if(e(t.displayName)!==y&&(n.Name=t.displayName),e(t.id)!==y&&(n.GPID=t.id+""),e(t.gender)!==y&&("male"===t.gender?n.Gender="M":"female"===t.gender?n.Gender="F":"other"===t.gender&&(n.Gender="O")),e(t.image)!==y&&(t.image.isDefault||(n.Photo=t.image.url.split("?sz")[0])),e(t.emails)!==y)for(var r=0;r<t.emails.length;r++){var i=t.emails[r];"account"===i.type&&(n.Email=i.value)}if(t.organizations){n.Employed="N";for(var o=0;o<t.organizations.length;o++){if("work"===t.organizations[o].type){n.Employed="Y";break}}}if(t.birthday){var s=t.birthday.split("-");n.DOB=K.setDate(s[0]+s[1]+s[2])}return t.relationshipStatus&&(n.Married="N","married"===t.relationshipStatus&&(n.Married="Y")),K.log.debug("gplus usr profile "+JSON.stringify(n)),n},fe=function(e){var t={};t.Name=e.name,e.id&&(t.FBID=e.id+""),"male"===e.gender?t.Gender="M":"female"===e.gender?t.Gender="F":t.Gender="O";e.relationship_status&&(t.Married="N","Married"===e.relationship_status&&(t.Married="Y"));var n=function(e){if(e){for(var t="",n="",r=0;r<e.length;r++){var i=e[r];if(i.type){var o=i.type;if("Graduate School"===o)return"Graduate";"College"===o?t="1":"High School"===o&&(n="1")}}if("1"===t)return"College";if("1"===n)return"School"}}(e.education);if(n&&(t.Education=n),t.Employed=e.work?"Y":"N",e.email&&(t.Email=e.email),e.birthday){var r=e.birthday.split("/");t.DOB=K.setDate(r[2]+r[0]+r[1])}return t},de=void 0,ve=function(e){if(K.isObject(e)){for(var t in e)if(e.hasOwnProperty(t)){if(K.isObject(e[t])||K.isArray(e[t]))return!1;K.isDateObject(e[t])&&(e[t]=K.convertToWZRKDate(e[t]))}return!0}return!1},ge=ve,he=function(t){var n=!0;if(K.isObject(t))for(var r in t)if(t.hasOwnProperty(r)){var i=t[r];if((void 0===i?"undefined":e(i))===y){delete t[r];continue}"Gender"!==r||i.match(/^M$|^F$/)||(n=!1,K.log.error(P.MESSAGES.gender)),"Employed"!==r||i.match(/^Y$|^N$/)||(n=!1,K.log.error(P.MESSAGES.employed)),"Married"!==r||i.match(/^Y$|^N$/)||(n=!1,K.log.error(P.MESSAGES.married)),"Education"!==r||i.match(/^School$|^College$|^Graduate$/)||(n=!1,K.log.error(P.MESSAGES.education)),"Age"===r&&(void 0===i?"undefined":e(i))!==y&&(K.isConvertibleToNumber(i)?t.Age=+i:(n=!1,K.log.error(P.MESSAGES.age))),"DOB"===r?(/^\$D_/.test(i)&&11===(i+"").length||K.isDateObject(i)||(n=!1,K.log.error(P.MESSAGES.dob)),K.isDateObject(i)&&(t[r]=K.convertToWZRKDate(i))):K.isDateObject(i)&&(t[r]=K.convertToWZRKDate(i)),"Phone"!==r||K.isObjectEmpty(i)||(i.length>8&&"+"===i.charAt(0)?(i=i.substring(1,i.length),K.isConvertibleToNumber(i)?t.Phone=+i:(n=!1,K.log.error(P.MESSAGES.phoneFormat+". Removed."))):(n=!1,K.log.error(P.MESSAGES.phoneFormat+". Removed."))),n||delete t[r]}return n},pe=function(t,n){if(K.isObject(t)){for(var r in t)if(t.hasOwnProperty(r))if("Items"===r){if(!K.isArray(t[r]))return!1;t[r].length>16&&n&&n(522,"Charged Items exceed 16 limit. Actual count: "+t[r].length+". Additional items will be dropped.");for(var i in t[r])if(t[r].hasOwnProperty(i)&&(!K.isObject(t[r][i])||!ve(t[r][i])))return!1}else{if(K.isObject(t[r])||K.isArray(t[r]))return!1;K.isDateObject(t[r])&&(t[r]=K.convertToWZRKDate(t[r]))}if(e(t[s])!==y){var o=t[s],u=H.getChargedIdKey();if((void 0===de?"undefined":e(de))===y&&(de=H.read(u)),(void 0===de?"undefined":e(de))!==y&&de===o)return K.log.error("Duplicate charged Id - Dropped"+t),!1;de=o,H.save(u,o)}return!0}return!1},ye=[],me=function(){function e(n,r){if(t(this,e),this.api=n,ye.push=function(t){var n=e.generateProfileObj(t),r=e.generateProfileEvent(n);this.api.processEvent(r)}.bind(this),r&&r.length>0)for(var i=0;i<r.length;i++)this.push(r[i])}return n(e,[{key:"push",value:function(){return ye.push(Array.prototype.slice.call(arguments)),!0}},{key:"getAttribute",value:function(e){return this.api.getProfileAttribute(e)}}],[{key:"getCachedGUIDForIdentity",value:function(e,t){if(!e||!t)return null;var n=H.getIdentitiesMapKey();if(!n)return null;return(H.read(n)||{})[e+"_"+t]||null}},{key:"extractIdentifiersFromProfileObj",value:function(e){if(!e||K.isObjectEmpty(e))return null;var t=[];return e.Email&&t.push({type:S.EMAIL,id:e.Email}),e.GPID&&t.push({type:S.GPID,id:e.GPID}),e.FBID&&t.push({type:S.FBID,id:e.FBID}),e.Identity&&t.push({type:S.IDENTITY,id:e.Identity}),t}},{key:"generateProfileObj",value:function(e){var t;if(!K.isArray(e)||e.length<=0)return null;for(var n=0;n<e.length;n++){var r=e[n];if(t=null,r.Site){if(t=r.Site,K.isObjectEmpty(t)||!he(t))return null}else if(r.Facebook){var i=r.Facebook;K.isObjectEmpty(i)||i.error||(t=fe(i))}else if(r["Google Plus"]){var o=r["Google Plus"];K.isObjectEmpty(o)||o.error||(t=ce(o))}if(t&&!K.isObjectEmpty(t)){t.tz||(t.tz=(new Date).toString().match(/([A-Z]+[\+-][0-9]+)/)[1]);break}}return t}},{key:"generateProfileEvent",value:function(t){if(!t||K.isObjectEmpty(t))return null;var n=e.extractIdentifiersFromProfileObj(t);return n.length>0&&function(e){var t=H.getIdentitiesMapKey(),n=V.getGUID();if(n&&e&&!(e.length<=0)){for(var r=H.read(t)||{},i=0;i<e.length;i++){var o=e[i];o.type&&o.id&&(r[o.type+"_"+o.id]=n)}H.save(t,r)}}(n),{ep:K.getNow(),type:E.PROFILE,profile:t}}}]),e}(),Ee=function(){function e(n,r){t(this,e),this.url=n,this.data=r||[]}return n(e,[{key:"send",value:function(e){var t=new XMLHttpRequest({mozSystem:!0});t.open("post",this.url,!0),t.responseType="json",t.addEventListener("error",function(){e&&e(t.status,t.error)}),t.addEventListener("load",function(){e&&e(t.status,t.response)}),t.setRequestHeader("Accept","application/json"),t.setRequestHeader("Content-Type","application/json"),t.send(JSON.stringify(this.data)),K.log.debug("req snt -> url: "+this.url)}}]),e}(),_e=function(e){var t=H.read(e);return K.isArray(t)?t:[]},Se=function(e){var t=H.read(e)||0;return parseInt(t,10)},be=function(){return H.getSavedEventsKey()},ke=function(){return H.getSavedProfilesKey()},Ie=function(){return H.getSavedSequenceNumberKey()},Pe=function(){return H.getARPKey()},we=function(){function r(e){t(this,r),this.options=e,this._uploading=!1,this._unsentEvents=_e(be()),this._unsentProfiles=_e(ke()),this._sequenceNumber=Se(Ie()),this.REQ_N=0,this.RESP_N=0,this._requestScheduled=!1,this._blockRequeust=!1,this._scheduleEvents()}return n(r,[{key:"clearEvents",value:function(e){var t=this;this._sendEvents(function(){t._unsentEvents=[],t._unsentProfiles=[],t._saveEvents(),e()})}},{key:"queueEvent",value:function(e){if(e){e._seq=this._nextSequenceNumber();K.log.debug("Queuing event "+JSON.stringify(e)),e.type===E.PROFILE?this._unsentProfiles.push(e):this._unsentEvents.push(e),this._saveEvents(),this._scheduleEvents()}}},{key:"_getEndPoint",value:function(){return o.getRegion()&&(this.options.domain=o.getRegion()+"."+this.options.domain),this.options.protocol+"//"+this.options.domain+"/a2?t=77"}},{key:"_unsentCount",value:function(){return this._unsentEvents.length+this._unsentProfiles.length}},{key:"_scheduleEvents",value:function(e){return 0===this._unsentCount()?(K.log.debug("No events in the queue, not scheduling an event update"),!1):this._unsentCount()>=this.options.eventUploadThreshold?(this._sendEvents(e),!0):this._requestScheduled?(K.log.debug("Event upload scheduled"),!1):(K.log.debug("Scheduling an event upload in "+this.options.eventUploadInterval/1e3+" seconds"),this._requestScheduled=!0,setTimeout(function(){this._requestScheduled=!1,this._sendEvents()}.bind(this),this.options.eventUploadInterval),!1)}},{key:"_saveEvents",value:function(){H.save(be(),this._unsentEvents),H.save(ke(),this._unsentProfiles)}},{key:"_trimEventsQueued",value:function(e){e.length>this.options.maxSavedEventCount&&e.splice(0,e.length-this.options.maxSavedEventCount)}},{key:"_removeEvents",value:function(e,t){this._removeEventsFromQueue("_unsentEvents",e),this._removeEventsFromQueue("_unsentProfiles",t)}},{key:"_removeEventsFromQueue",value:function(e,t){if(!(t<0)){for(var n=[],r=0;r<this[e].length;r++)this[e][r]._seq>t&&n.push(this[e][r]);this[e]=n}}},{key:"_nextSequenceNumber",value:function(){return this._sequenceNumber++,H.save(Ie(),this._sequenceNumber),this._sequenceNumber}},{key:"_mergeEventQueues",value:function(e){for(var t=[],n=0,r=-1,i=0,o=-1;t.length<e;){var s,u=i>=this._unsentProfiles.length,a=n>=this._unsentEvents.length;if(a&&u){K.log.error("Problem merging event queues, fewer events than expected");break}u?r=(s=this._unsentEvents[n++])._seq:a?o=(s=this._unsentProfiles[i++])._seq:this._unsentEvents[n]._seq<this._unsentProfiles[i]._seq?r=(s=this._unsentEvents[n++])._seq:o=(s=this._unsentProfiles[i++])._seq,t.push(s)}return{eventsToSend:t,maxEventId:r,maxProfilesId:o}}},{key:"_sendEvents",value:function(t){var n=!1,r="";if(this._uploading&&(n=!0,r="Already Uploading"),this._unsentCount()<=0&&(n=!0,r="No events in the queue"),this._blockRequeust&&(n=!0,r="Uploading temporarily blocked"),n){var i="Skipping events upload: "+r;return K.log.debug(i),void("function"==typeof t&&t(0,i))}this._uploading=!0;var s=V.getGUID(),u={id:o.getAccountId(),"SDK Version":1e4,s:""+ie.getSessionId()};if(this.options.enablePersonalization){"undefined"===y||"undefined"===y?u.dsync=!0:NaN<l&&(u.dsync=!0)}var a=this._getEndPoint(),l=K.getNow();this._blockRequeust||(l===this._requestTime?this._seqNo++:(this._requestTime=l,this._seqNo=0)),a=this._addToURL(a,"sn",this._seqNo),null!==s&&(a=this._addToURL(a,"gc",s),u.g=s),a=this._addARPToRequest(a),a=this._addToURL(a,"r",(new Date).getTime()),a=this._addToURL(a,"rn",++this.REQ_N),a=this._addToURL(a,"d",le(JSON.stringify(u)));var c=Math.min(this._unsentCount(),this.options.uploadBatchSize),f=this._mergeEventQueues(c),d=f.maxEventId,v=f.maxProfilesId,g=f.eventsToSend,h=this;K.log.debug("Sending events: "+JSON.stringify(g)),new Ee(a,g).send(function(n,r){h.uploading=!1,r=r||{},K.log.debug("handling response "+JSON.stringify(r));try{if(200===n){var i=r.meta||{},o=0;i.rn&&(o=parseInt(i.rn,10));var s=!0;e(i.rf)!==y&&(s=i.rf),s&&(h._blockRequeust=!1),r.g&&V.setGUID(r.g),h.RESP_N=o,h._removeEvents(d,v),h._saveEvents(),h._updateARP(r),h._sendEvents(t)||"function"!=typeof t||t(n,r)}else 413===n?(K.log.error("request too large"),1===h.options.uploadBatchSize&&h._removeEvents(d,v),h.options.uploadBatchSize=Math.ceil(c/2),h._sendEvents(t)):"function"==typeof t&&t(n,r)}catch(e){K.log.error("Events upload failed: "+e.message+" ")}})}},{key:"_updateARP",value:function(){var e=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).arp;if(e){var t=Pe();try{var n=H.read(t)||{};for(var r in e)e.hasOwnProperty(r)&&(-1===e[r]?delete n[r]:n[r]=e[r]);H.save(t,n)}catch(e){K.log.error("Unable to parse ARP JSON: "+e)}}}},{key:"_addARPToRequest",value:function(e){var t=Pe();if(!t)return e;var n=H.read(t);return n?this._addToURL(e,"arp",le(JSON.stringify(n))):e}},{key:"_addToURL",value:function(e,t,n){return e+"&"+t+"="+encodeURIComponent(n)}}]),r}(),De=function(e,t){var n={type:e,ep:K.getNow()};t&&t(n)},Ae=function(){function e(n){t(this,e),this.options=n,this.queueManager=new we(Object.assign({},this.options)),this._newSession()}return n(e,[{key:"getCleverTapID",value:function(){return V.getGUID()}},{key:"getTimeElapsed",value:function(){return this._isPersonalizationActive()?this.session.getTimeElapsed():0}},{key:"getPageCount",value:function(){return this._isPersonalizationActive()?this.session.getPageCount():0}},{key:"getTotalVisits",value:function(){return this._isPersonalizationActive()?this.session.getTotalVisits():0}},{key:"getLastVisit",value:function(){return this._isPersonalizationActive()?this.session.getLastVisit():0}},{key:"getEventDetails",value:function(e){if(this._isPersonalizationActive()){var t=this._getEventsMap()[e];if(!t)return null;var n={};return n.firstTime=new Date(1e3*t[1]),n.lastTime=new Date(1e3*t[2]),n.count=t[0],n}}},{key:"getProfileAttribute",value:function(e){if(this._isPersonalizationActive())return this._getProfilesMap()[e]}},{key:"processEvent",value:function(e){K.isObject(e)&&(e.type===E.EVENT&&this._addToLocalEventMap(e.evtName),e.type===E.PROFILE&&this._addToLocalProfileMap(e.profile),e=this._addSystemDataToObject(e,void 0),this.queueManager.queueEvent(e))}},{key:"onUserLogin",value:function(e){var t=this,n=me.generateProfileObj(e),r=V.getGUID();if(r&&n){for(var i,o=me.extractIdentifiersFromProfileObj(n)||[],s=o.length>0,u=0;u<o.length;u++){var a=o[u];if(a.type&&a.id&&(i=me.getCachedGUIDForIdentity(a.type,a.id)))break}return!s||K.isAnonymousDevice()?(K.log.debug("onUserLogin: either don't have identifier or device is anonymous, associating profile "+JSON.stringify(n)+" with current user profile"),void this._processProfileEvent(n)):i&&i===r?(K.log.debug("onUserLogin: profile "+JSON.stringify(n)+" maps to current device id "+r+", using current user profile"),void this._processProfileEvent(n)):void(this.processingUserLogin?K.log.debug("Already processing onUserLogin for "+this.processingUserLoginKey+" , will not process for profile: "+JSON.stringify(n)):(this.processingUserLogin=!0,this.processingUserLoginKey=JSON.stringify(n),K.log.debug("Processing onUserLogin for "+this.processingUserLoginKey),this.queueManager.clearEvents(function(){i?V.setGUID(i):V.generateGUID(),t._clearDataMaps(),t._newSession(),t._processProfileEvent(n),t.processingUserLogin=!1,t.processingUserLoginKey=null})))}}},{key:"_newSession",value:function(){this.session=new ie(Object.assign({},this.options)),this._generateLaunchEvents()}},{key:"_generateLaunchEvents",value:function(){var e=this;!function(e){De(E.EVENT,function(t){t.evtName=_,t.evtData={"SDK Version":1e4},e&&e(t)})}(function(t){e.processEvent(t)}),this.options.sendPages&&De(E.PAGE,function(t){e.processEvent(t)})}},{key:"_getEventsMap",value:function(){if(!se){var e=H.getUserEventsKey();se=H.read(e)||{}}return se}},{key:"_getProfilesMap",value:function(){if(!ue){var e=H.getUserProfileKey();ue=H.read(e)||{}}return ue}},{key:"_clearDataMaps",value:function(){se=null,ue=null}},{key:"_startPings",value:function(){if(this.options.sendPings){var e=this;setInterval(function(){De(E.PING,function(t){e.processEvent(t)})},m)}}},{key:"_isPersonalizationActive",value:function(){return this.options.enablePersonalization}},{key:"_processProfileEvent",value:function(e){var t=me.generateProfileEvent(e);this.processEvent(t)}},{key:"_addToLocalEventMap",value:function(e){if(e){var t=this._getEventsMap(),n=K.getNow(),r=t[e];r?(r[2]=n,r[0]++):((r=[]).push(1),r.push(n),r.push(n)),t[e]=r;var i=H.getUserEventsKey();H.save(i,t)}}},{key:"_addToLocalProfileMap",value:function(e){if(e){var t=this._getProfilesMap();if(e._custom){var n=e._custom;for(var r in n)n.hasOwnProperty(r)&&(e[r]=n[r]);delete e._custom}for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);t._custom&&delete t._custom;var o=H.getUserProfileKey();H.save(o,t)}}},{key:"_addSystemDataToObject",value:function(e,t){t||(e=K.removeUnsupportedChars(e,function(e,t){K.reportError(e,t)}));var n=P.popError();return n&&(e.wzrk_error=n),e.id=o.getAccountId(),V.getGUID()&&(e.g=V.getGUID()),e.s=ie.getSessionId(),e.pg=this.session.getPageCount(),e.f=this.session.isFirstSession(),e}}]),e}(),Oe=[],Ne=function(e){if(K.isArray(e)){for(var t=function(e,t){K.reportError(e,t)},n=null;e.length>0;){var r=e.shift();if(!K.isString(r))return void K.log.error(P.MESSAGES.event);if(r.length>1024&&(r=r.substring(0,1024),K.reportError(510,r+"... length exceeded 1024 chars. Trimmed.")),"Stayed"!==r&&"UTM Visited"!==r&&"App Launched"!==r&&"Notification Sent"!==r&&"Notification Viewed"!==r&&"Notification Clicked"!==r){if(n={type:E.EVENT,ep:K.getNow(),evtName:K.sanitize(r,K.unsupportedKeyCharRegex)},0!==e.length){var i=e.shift();if(K.isObject(i)){if("Charged"===r){if(pe(i),t){K.reportError(511,"Charged event structure invalid. Not sent.");continue}}else if(!ge(i)){K.reportError(512,r+" event structure invalid. Not sent.");continue}n.evtData=i}else e.unshift(i)}}else K.reportError(513,r+" is a restricted system event. It cannot be used as an event name.")}return n}},Te=function(){function e(n,r){if(t(this,e),this.api=n,Oe.push=function(e){var t=Ne(e);this.api.processEvent(t)}.bind(this),r&&r.length>0)for(var i=0;i<r.length;i++)this.push(r[i])}return n(e,[{key:"push",value:function(){return Oe.push(Array.prototype.slice.call(arguments)),!0}},{key:"getDetails",value:function(e){return this.api.getEventDetails(e)}}]),e}(),Ue={domain:"50d1d285.ngrok.io",protocol:"https:",enablePersonalization:!0,eventUploadInterval:1e3,eventUploadThreshold:50,maxSavedEventCount:1e3,uploadBatchSize:50,sendPages:!1,sendPings:!1},Ce=function(){function e(n){t(this,e),this.api=n}return n(e,[{key:"getTimeElapsed",value:function(){return this.api.getTimeElapsed()}},{key:"getPageCount",value:function(){return this.api.getPageCount()}}]),e}(),Ge=function(){function e(n){t(this,e),this.api=n}return n(e,[{key:"getTotalVisits",value:function(){return this.api.getTotalVisits()}},{key:"getLastVisit",value:function(){return this.api.getLastVisit()}}]),e}(),Re=[],Le=function(){function e(n,r){if(t(this,e),this.api=n,Re.push=function(e){this.api.onUserLogin(e)}.bind(this),r&&r.length>0)for(var i=0;i<r.length;i++)this.push(r[i])}return n(e,[{key:"push",value:function(){return Re.push(Array.prototype.slice.call(arguments)),!0}}]),e}();return new(function(){function e(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};t(this,e),this.options=Object.assign({},Ue),this.event=n.event||[],this.profile=n.profile||[],this.onUserLogin=n.onUserLogin||[],this.logLevels=K.logLevels}return n(e,[{key:"init",value:function(e,t){K.isEmptyString(e)?K.log.error(P.MESSAGES.init):(o.setAccountId(e),o.setRegion(t),this.api=new Ae(Object.assign({},this.options)),this.session=new Ce(this.api),this.user=new Ge(this.api),this.onUserLogin=new Le(this.api,this.onUserLogin),this.event=new Te(this.api,this.event),this.profile=new me(this.api,this.profile))}},{key:"getCleverTapID",value:function(){return this.api.getCleverTapID()}},{key:"setLogLevel",value:function(e){K.setLogLevel(e)}},{key:"getLogLevel",value:function(){return K.getLogLevel()}}]),e}())(window.clevertap)});
