!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.clevertap=t()}(this,function(){"use strict";var s={APP_LAUNCHED:"App Launched",CHARGED_ID:"chargedId",ECOOKIE_PREFIX:"CT_E",GCOOKIE_NAME:"CT_G",VAPID_KEY:"CT_VKEY",KCOOKIE_NAME:"CT_K",PCOOKIE_PREFIX:"CT_P",SEQCOOKIE_PREFIX:"CT_SEQ",SCOOKIE_PREFIX:"CT_S",EV_COOKIE:"CT_EV",PR_COOKIE:"CT_PR",ARP_COOKIE:"CT_ARP",UNDEFINED:"undefined",PING_FREQ_IN_MILLIS:12e4,EVENT_TYPES:{EVENT:"event",PROFILE:"profile",PAGE:"page",PING:"ping",DATA:"data"},IDENTITY_TYPES:{IDENTITY:"Identity",EMAIL:"Email",FBID:"FBID",GPID:"GPID"},TOKEN_UPDATE_TS_KEY:"CT_TK_TS",KAIOS_NOTIFICATION_STATE:"CT_KOS_S",SW_UNREGISTER_FOR_VERSION:"CT_SW_VR",APP_VERSION_KEY:"CT_AP_VR"},e="This property has been ignored.",t={init:"Invalid account id",event:"Event structure not valid. Unable to process event",gender:"Gender value should be either M or F. "+e,employed:"Employed value should be either Y or N. "+e,married:"Married value should be either Y or N. "+e,education:"Education value should be either School, College or Graduate. "+e,age:"Age value should be a number. "+e,dob:"DOB value should be a Date Object",objArr:"Expecting Object array in profile",dateFormat:"setDate(number). number should be formatted as yyyymmdd",enumFormat:"setEnum(value). value should be a string or a number",phoneFormat:"Phone number should be formatted as +[country code][number]"},a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};"function"==typeof Symbol&&Symbol.asyncIterator&&(n.prototype[Symbol.asyncIterator]=function(){return this}),n.prototype.next=function(e){return this._invoke("next",e)},n.prototype.throw=function(e){return this._invoke("throw",e)},n.prototype.return=function(e){return this._invoke("return",e)};function l(e){this.value=e}function n(i){var o,s;function a(e,t){try{var n=i[e](t),r=n.value;r instanceof l?Promise.resolve(r.value).then(function(e){a("next",e)},function(e){a("throw",e)}):u(n.done?"return":"normal",n.value)}catch(e){u("throw",e)}}function u(e,t){switch(e){case"return":o.resolve({value:t,done:!0});break;case"throw":o.reject(t);break;default:o.resolve({value:t,done:!1})}(o=o.next)?a(o.key,o.arg):s=null}this._invoke=function(n,r){return new Promise(function(e,t){t={key:n,arg:r,resolve:e,reject:t,next:null};s?s=s.next=t:(o=s=t,a(n,r))})},"function"!=typeof i.return&&(this.return=void 0)}var r=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},i=function(e,t,n){return t&&o(e.prototype,t),n&&o(e,n),e};function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var u=[],c=(i(g,null,[{key:"pushError",value:function(e,t){u.push({c:e,d:t})}},{key:"popError",value:function(){return u.shift()}}]),g);function g(){r(this,g)}c.MESSAGES=t;function d(e){return"string"==typeof e||e instanceof String}function v(){try{return window.localStorage.setItem("wzrk_debug","12345678"),window.localStorage.removeItem("wzrk_debug"),"localStorage"in window&&null!==window.localStorage}catch(e){return!1}}function f(e){if(!e)return null;var t=null;if((void 0===(t=v()?localStorage[e]||null:t)?"undefined":a(t))!==s.UNDEFINED&&null!==t)try{t=JSON.parse(t)}catch(e){}return t}var p=new RegExp("^\\s+|\\.|:|\\$|'|\"|\\\\|\\s+$","g"),h=new RegExp("^\\s+|'|\"|\\\\|\\s+$","g"),y=new RegExp('"',"g"),e=new RegExp("'","g"),E=function(e,t){return e.replace(t,"")},_=f,S=function(e,t){if(e&&(void 0===t?"undefined":a(t))!==s.UNDEFINED&&null!==t)try{v()&&(localStorage[e]=JSON.stringify(t))}catch(e){}},I=function(e){e&&v()&&delete localStorage[e]},m=(i(b,null,[{key:"save",value:function(e,t){e&&t&&S(e,t)}},{key:"read",value:function(e){return e?_(e):null}},{key:"remove",value:function(e){e&&I(e)}},{key:"getVAPIDKey",value:function(){var e=z.getAccountId();return e?s.VAPID_KEY+"_"+e:null}},{key:"getTokenUpdateTsKey",value:function(){var e=z.getAccountId();return e?s.TOKEN_UPDATE_TS_KEY+"_"+e:null}},{key:"getLastUnregisterForVersionKey",value:function(){var e=z.getAccountId();return e?s.SW_UNREGISTER_FOR_VERSION+"_"+e:null}},{key:"getKaiosNotificationStateKey",value:function(){var e=z.getAccountId();return e?s.KAIOS_NOTIFICATION_STATE+"_"+e:null}},{key:"getAppVersionKey",value:function(){var e=z.getAccountId();return e?s.APP_VERSION_KEY+"_"+e:null}},{key:"getGUIDKey",value:function(){var e=z.getAccountId();return e?s.GCOOKIE_NAME+"_"+e:null}},{key:"getSessionKey",value:function(){var e=z.getAccountId(),t=M.getGUID();return e&&t?s.SCOOKIE_PREFIX+"_"+e+"_"+t:null}},{key:"getUserEventsKey",value:function(){var e=z.getAccountId(),t=M.getGUID();return e&&t?s.EV_COOKIE+"_"+e+"_"+t:null}},{key:"getUserProfileKey",value:function(){var e=z.getAccountId(),t=M.getGUID();return e&&t?s.PR_COOKIE+"_"+e+"_"+t:null}},{key:"getSavedEventsKey",value:function(){var e=z.getAccountId(),t=M.getGUID();return e&&t?s.ECOOKIE_PREFIX+"_"+e+"_"+t:null}},{key:"getSavedProfilesKey",value:function(){var e=z.getAccountId(),t=M.getGUID();return e&&t?s.PCOOKIE_PREFIX+"_"+e+"_"+t:null}},{key:"getSavedSequenceNumberKey",value:function(){var e=z.getAccountId();return e?s.SEQCOOKIE_PREFIX+"_"+e:null}},{key:"getARPKey",value:function(){var e=z.getAccountId(),t=M.getGUID();return e&&t?s.ARP_COOKIE+"_"+e+"_"+t:null}},{key:"getMetaKey",value:function(){var e=z.getAccountId(),t=M.getGUID();return e&&t?s.META_COOKIE+"_"+e+"_"+t:null}},{key:"getIdentitiesMapKey",value:function(){var e=z.getAccountId();return e?s.KCOOKIE_NAME+"_"+e:null}},{key:"getChargedIdKey",value:function(){var e=z.getAccountId();return e?s.CHARGED_ID+"_"+e:null}}]),b);function b(){r(this,b)}function T(e){for(var t in e)if(e.hasOwnProperty(t))return!1;return!0}function k(e){return"string"==typeof e||e instanceof String}function A(e){return/^-?[\d.]+(?:e-?\d+)?$/.test(e)&&"number"==typeof e}function P(){try{return window.localStorage.setItem("wzrk_debug","12345678"),window.localStorage.removeItem("wzrk_debug"),"localStorage"in window&&null!==window.localStorage}catch(e){return!1}}function N(e){if(!e)return null;var t=null;if((void 0===(t=P()?localStorage[e]||null:t)?"undefined":a(t))!==s.UNDEFINED&&null!==t)try{t=JSON.parse(t)}catch(e){}return t}function D(e){return e?(e^window.crypto.getRandomValues(new Uint8Array(1))[0]%16>>e/4).toString(16):([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,D)}var O={DISABLE:0,ERROR:1,INFO:2,DEBUG:3},w=O.INFO,U={error:function(e){O.ERROR<=w&&C("error",e)},info:function(e){O.INFO<=w&&C("log",e)},debug:function(e){O.DEBUG<=w&&C("debug",e)}},C=function(e,t){if(window.console)try{var n=(new Date).getTime();console[e]("CleverTap ["+n+"]: "+t)}catch(e){}},K=function(e){var t=/^(\d{4})(\d{2})(\d{2})$/.exec(e);if(null===t)return!1;var n=t[3],r=t[2]-1,e=t[1],t=new Date(e,r,n);return t.getDate()===n&&t.getMonth()===r&&t.getFullYear()===e},R=new RegExp("^\\s+|\\.|:|\\$|'|\"|\\\\|\\s+$","g"),V=new RegExp("^\\s+|'|\"|\\\\|\\s+$","g"),t=new RegExp('"',"g"),y=new RegExp("'","g"),e=function e(t,n){var r,i,o,s;if("object"!==(void 0===t?"undefined":a(t)))return k(t)?1024<(r=L(t,V)).length&&(r=r.substring(0,1024),n&&n(521,r+"... length exceeded 1024 chars. Trimmed.")):r=t,r;for(i in t)t.hasOwnProperty(i)&&(o=e(t[i]),s=k(i)?L(i,R):i,k(i)?1024<(s=L(i,R)).length&&(s=s.substring(0,1024),n&&n(520,s+"... length exceeded 1024 chars. Trimmed.")):s=i,delete t[i],t[s]=o);return t},L=function(e,t){return e.replace(t,"")},F={logLevels:O,setLogLevel:function(e){w=e},getLogLevel:function(){return w},log:U,setDate:function(e){if(K(e))return"$D_"+e;U.error(c.MESSAGES.dateFormat)},isDateObject:function(e){return"object"===(void 0===e?"undefined":a(e))&&e instanceof Date},convertToWZRKDate:function(e){return"$D_"+Math.round(e.getTime()/1e3)},isDateValid:K,isArray:function(e){return"object"===(void 0===e?"undefined":a(e))&&e instanceof Array},isObject:function(e){return"[object Object]"===Object.prototype.toString.call(e)},isObjectEmpty:T,isEmptyString:function(e){return!e||0===e.length},isString:k,isConvertibleToNumber:function(e){return!isNaN(parseFloat(e))&&isFinite(e)},isNumber:A,arrayContains:function(e,t){for(var n=e.length;n--;)if(e[n]===t)return!0;return!1},getDomain:function(e){if(""===e)return"";var t=document.createElement("a");return t.href=e,t.hostname},removeUnsupportedChars:e,sanitize:L,isLocalStorageSupported:P,getToday:function(){var e=new Date;return e.getFullYear()+""+e.getMonth()+e.getDay()},getNow:function(){return Math.floor((new Date).getTime()/1e3)},unsupportedKeyCharRegex:R,unsupportedValueCharRegex:V,doubleQuoteRegex:t,singleQuoteRegex:y,readFromStorage:N,saveToStorage:function(e,t){if(e&&(void 0===t?"undefined":a(t))!==s.UNDEFINED&&null!==t)try{P()&&(localStorage[e]=JSON.stringify(t))}catch(e){}},removeFromStorage:function(e){e&&P()&&delete localStorage[e]},setEnum:function(e){if(k(e)||A(e))return"$E_"+e;U.error(c.MESSAGES.enumFormat)},reportError:function(e,t){c.pushError(e,t)},isAnonymousDevice:function(){var e=m.getIdentitiesMapKey(),e=N(e)||{};return T(e)}},G=null,M=(i(j,null,[{key:"setGUID",value:function(e){G=e;var t=m.getGUIDKey();null===e?m.remove(t):m.save(t,e)}},{key:"getGUID",value:function(){var e;return G||(e=m.getGUIDKey(),G=m.read(e)),G||j.generateGUID(),G}},{key:"generateGUID",value:function(){var e="fx"+D().replace(/[-]/g,"");F.log.debug("Generating Device ID: "+e),j.setGUID(e)}},{key:"setVAPID",value:function(e){var t=m.getVAPIDKey();null===e?m.remove(t):m.save(t,e)}},{key:"getVAPID",value:function(){var e=m.getVAPIDKey();return m.read(e)}},{key:"setLastTokenUpdateTs",value:function(e){var t=m.getTokenUpdateTsKey();m.save(t,e)}},{key:"getLastTokenUpdateTs",value:function(){var e=m.getTokenUpdateTsKey(),e=m.read(e);return F.log.debug("last updated ts : "+e),e}},{key:"setLastSWUnregistrationForVersion",value:function(e){var t=m.getLastUnregisterForVersionKey();m.save(t,e)}},{key:"getLastSWUnregistrationForVersion",value:function(){var e=m.getLastUnregisterForVersionKey(),e=m.read(e);return null===e&&(F.log.debug("no last unregistration has been set, returning current version"),e=j.getAppVersion()),F.log.debug("last unregistered on version : = "+e),e}},{key:"getKaiOsNotificationState",value:function(){var e=m.getKaiosNotificationStateKey(),e=m.read(e);return e||!1}},{key:"setKaiOsNotificationState",value:function(e){var t=m.getKaiosNotificationStateKey();m.save(t,e)}},{key:"getAppVersion",value:function(){var e=m.getAppVersionKey(),e=m.read(e);return F.log.debug("app version : = "+e),e}},{key:"setAppVersion",value:function(e){var t=m.getAppVersionKey();m.save(t,e)}}]),j);function j(){r(this,j)}var x=null,q=null,Y=null,z=(i(W,null,[{key:"setAccountId",value:function(e){x=e}},{key:"getAccountId",value:function(){return x}},{key:"setRegion",value:function(e){q=e}},{key:"getRegion",value:function(){return q}},{key:"setAppVersion",value:function(e){Y=e,M.setAppVersion(e)}},{key:"getAppVersion",value:function(){return Y}}]),W);function W(){r(this,W)}function B(){return m.getSessionKey()}var J,$=0,Q=0,H=0,X=0,Z=function(){var e=B(),e=m.read(e)||{};return e=!F.isObject(e)?{}:e},ee=function(e){var t=B();m.save(t,e)},te=(i(ne,[{key:"isFirstSession",value:function(){return J}},{key:"getPageCount",value:function(){return X}},{key:"getTimeElapsed",value:function(){var e=ne.getSessionId();return e<=0?0:Math.floor(F.getNow()-e)}},{key:"getTotalVisits",value:function(){return H}},{key:"getLastVisit",value:function(){return 0<Q?new Date(1e3*Q):0}}],[{key:"getSessionId",value:function(){return $}}]),ne);function ne(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};r(this,ne),this.options=e,$=F.getNow();e=Z();Q=e.ps||0,J=Q<=0,X=e.p||1,H=(e.sc||0)+1,e.ps=$,e.p=X,e.sc=H,ee(e)}var re={_f:String.fromCharCode,getKeyStr:function(){for(var e="",t=0,t=0;t<=25;t++)e+=String.fromCharCode(t+65);for(t=0;t<=25;t++)e+=String.fromCharCode(t+97);for(t=0;t<10;t++)e+=t;return e+"+/="},convertToFormattedHex:function(e){var t,n,r,i="";if(!F.isArray(e))return!1;for(n=e.length,t=0;t<n;++t)e[t]<0&&(e[t]=e[t]+256),void 0===e[t]&&(e[t]=0),i+=r=1===(r=e[t].toString(16)).length?"0"+r:r;return i.trim()},convertStringToHex:function(e){for(var t=[],n=0;n<e.length;n++){var r=e.charCodeAt(n);t.push(255&r),t.push(r>>8&255)}return re.convertToFormattedHex(t)},compressToBase64:function(e){if(null===e)return"";var t,n,r,i,o,s,a,u="",l=0;for(e=re.compress(e);l<2*e.length;)l%2==0?(t=e.charCodeAt(l/2)>>8,n=255&e.charCodeAt(l/2),r=l/2+1<e.length?e.charCodeAt(l/2+1)>>8:NaN):(t=255&e.charCodeAt((l-1)/2),(l+1)/2<e.length?(n=e.charCodeAt((l+1)/2)>>8,r=255&e.charCodeAt((l+1)/2)):n=r=NaN),l+=3,i=t>>2,o=(3&t)<<4|n>>4,s=(15&n)<<2|r>>6,a=63&r,isNaN(n)?s=a=64:isNaN(r)&&(a=64),u=u+re._keyStr.charAt(i)+re._keyStr.charAt(o)+re._keyStr.charAt(s)+re._keyStr.charAt(a);return u},compress:function(e){if(null===e)return"";for(var t,n,r,i,o={},s={},a="",u=2,l=3,c=2,g="",d=0,v=0,f=re._f,p=0;p<e.length;p+=1)if(r=e.charAt(p),Object.prototype.hasOwnProperty.call(o,r)||(o[r]=l++,s[r]=!0),i=a+r,Object.prototype.hasOwnProperty.call(o,i))a=i;else{if(Object.prototype.hasOwnProperty.call(s,a)){if(a.charCodeAt(0)<256){for(t=0;t<c;t++)d<<=1,15===v?(v=0,g+=f(d),d=0):v++;for(n=a.charCodeAt(0),t=0;t<8;t++)d=d<<1|1&n,15===v?(v=0,g+=f(d),d=0):v++,n>>=1}else{for(n=1,t=0;t<c;t++)d=d<<1|n,15===v?(v=0,g+=f(d),d=0):v++,n=0;for(n=a.charCodeAt(0),t=0;t<16;t++)d=d<<1|1&n,15===v?(v=0,g+=f(d),d=0):v++,n>>=1}0===--u&&(u=Math.pow(2,c),c++),delete s[a]}else for(n=o[a],t=0;t<c;t++)d=d<<1|1&n,15===v?(v=0,g+=f(d),d=0):v++,n>>=1;0===--u&&(u=Math.pow(2,c),c++),o[i]=l++,a=String(r)}if(""!==a){if(Object.prototype.hasOwnProperty.call(s,a)){if(a.charCodeAt(0)<256){for(t=0;t<c;t++)d<<=1,15===v?(v=0,g+=f(d),d=0):v++;for(n=a.charCodeAt(0),t=0;t<8;t++)d=d<<1|1&n,15===v?(v=0,g+=f(d),d=0):v++,n>>=1}else{for(n=1,t=0;t<c;t++)d=d<<1|n,15===v?(v=0,g+=f(d),d=0):v++,n=0;for(n=a.charCodeAt(0),t=0;t<16;t++)d=d<<1|1&n,15===v?(v=0,g+=f(d),d=0):v++,n>>=1}0===--u&&(u=Math.pow(2,c),c++),delete s[a]}else for(n=o[a],t=0;t<c;t++)d=d<<1|1&n,15===v?(v=0,g+=f(d),d=0):v++,n>>=1;0===--u&&(u=Math.pow(2,c),c++)}for(n=2,t=0;t<c;t++)d=d<<1|1&n,15===v?(v=0,g+=f(d),d=0):v++,n>>=1;for(;;){if(d<<=1,15===v){g+=f(d);break}v++}return g}};re._keyStr=re.getKeyStr();function ie(e){if(F.isObject(e)){for(var t in e)if(e.hasOwnProperty(t)){if(F.isObject(e[t])||F.isArray(e[t]))return!1;F.isDateObject(e[t])&&(e[t]=F.convertToWZRKDate(e[t]))}return!0}return!1}var oe={compressToBase64:re.compressToBase64},se=function(e){return F.log.debug("dobj:"+e),oe.compressToBase64(e)},ae=function(e){var t,n={};if(a(e.displayName)!==s.UNDEFINED&&(n.Name=e.displayName),a(e.id)!==s.UNDEFINED&&(n.GPID=e.id+""),a(e.gender)!==s.UNDEFINED&&("male"===e.gender?n.Gender="M":"female"===e.gender?n.Gender="F":"other"===e.gender&&(n.Gender="O")),a(e.image)!==s.UNDEFINED&&(e.image.isDefault||(n.Photo=e.image.url.split("?sz")[0])),a(e.emails)!==s.UNDEFINED)for(var r=0;r<e.emails.length;r++){var i=e.emails[r];"account"===i.type&&(n.Email=i.value)}if(e.organizations){n.Employed="N";for(var o=0;o<e.organizations.length;o++)if("work"===e.organizations[o].type){n.Employed="Y";break}}return e.birthday&&(t=e.birthday.split("-"),n.DOB=F.setDate(t[0]+t[1]+t[2])),e.relationshipStatus&&(n.Married="N","married"===e.relationshipStatus&&(n.Married="Y")),F.log.debug("gplus usr profile "+JSON.stringify(n)),n},ue=function(e){var t={};t.Name=e.name,e.id&&(t.FBID=e.id+""),"male"===e.gender?t.Gender="M":"female"===e.gender?t.Gender="F":t.Gender="O";e.relationship_status&&(t.Married="N","Married"===e.relationship_status&&(t.Married="Y"));var n=function(e){if(e){for(var t="",n="",r=0;r<e.length;r++){var i=e[r];if(i.type){i=i.type;if("Graduate School"===i)return"Graduate";"College"===i?t="1":"High School"===i&&(n="1")}}return"1"===t?"College":"1"===n?"School":void 0}}(e.education);return n&&(t.Education=n),t.Employed=e.work?"Y":"N",e.email&&(t.Email=e.email),e.birthday&&(e=e.birthday.split("/"),t.DOB=F.setDate(e[2]+e[0]+e[1])),t},le=void 0,ce=ie,ge=function(e){var t,n=!0;if(F.isObject(e))for(var r in e)e.hasOwnProperty(r)&&((void 0===(t=e[r])?"undefined":a(t))!==s.UNDEFINED?("Gender"!==r||t.match(/^M$|^F$/)||(n=!1,F.log.error(c.MESSAGES.gender)),"Employed"!==r||t.match(/^Y$|^N$/)||(n=!1,F.log.error(c.MESSAGES.employed)),"Married"!==r||t.match(/^Y$|^N$/)||(n=!1,F.log.error(c.MESSAGES.married)),"Education"!==r||t.match(/^School$|^College$|^Graduate$/)||(n=!1,F.log.error(c.MESSAGES.education)),"Age"===r&&(void 0===t?"undefined":a(t))!==s.UNDEFINED&&(F.isConvertibleToNumber(t)?e.Age=+t:(n=!1,F.log.error(c.MESSAGES.age))),"DOB"===r&&(/^\$D_/.test(t)&&11===(t+"").length||F.isDateObject(t)||(n=!1,F.log.error(c.MESSAGES.dob))),F.isDateObject(t)&&(e[r]=F.convertToWZRKDate(t)),"Phone"!==r||F.isObjectEmpty(t)||(8<t.length&&"+"===t.charAt(0)?(t=t.substring(1,t.length),F.isConvertibleToNumber(t)?e.Phone=+t:(n=!1,F.log.error(c.MESSAGES.phoneFormat+". Removed."))):(n=!1,F.log.error(c.MESSAGES.phoneFormat+". Removed."))),n||delete e[r]):delete e[r]);return n},de=function(e,t){if(F.isObject(e)){for(var n in e)if(e.hasOwnProperty(n))if("Items"===n){if(!F.isArray(e[n]))return!1;for(var r in 16<e[n].length&&t&&t(522,"Charged Items exceed 16 limit. Actual count: "+e[n].length+". Additional items will be dropped."),e[n])if(e[n].hasOwnProperty(r)&&(!F.isObject(e[n][r])||!ie(e[n][r])))return!1}else{if(F.isObject(e[n])||F.isArray(e[n]))return!1;F.isDateObject(e[n])&&(e[n]=F.convertToWZRKDate(e[n]))}if(a(e[s.CHARGED_ID])!==s.UNDEFINED){var i=e[s.CHARGED_ID],o=m.getChargedIdKey();if((void 0===(le=(void 0===le?"undefined":a(le))===s.UNDEFINED?m.read(o):le)?"undefined":a(le))!==s.UNDEFINED&&le===i)return F.log.error("Duplicate charged Id - Dropped"+e),!1;le=i,m.save(o,i)}return!0}return!1},ve=[],fe=(i(pe,[{key:"push",value:function(){return ve.push(Array.prototype.slice.call(arguments)),!0}},{key:"getAttribute",value:function(e){return this.api.getProfileAttribute(e)}}],[{key:"getCachedGUIDForIdentity",value:function(e,t){if(!e||!t)return null;var n=m.getIdentitiesMapKey();return n&&(m.read(n)||{})[e+"_"+t]||null}},{key:"extractIdentifiersFromProfileObj",value:function(e){if(!e||F.isObjectEmpty(e))return null;var t=[];return e.Email&&t.push({type:s.IDENTITY_TYPES.EMAIL,id:e.Email}),e.GPID&&t.push({type:s.IDENTITY_TYPES.GPID,id:e.GPID}),e.FBID&&t.push({type:s.IDENTITY_TYPES.FBID,id:e.FBID}),e.Identity&&t.push({type:s.IDENTITY_TYPES.IDENTITY,id:e.Identity}),t}},{key:"generateProfileObj",value:function(e){if(!F.isArray(e)||e.length<=0)return null;for(var t=0;t<e.length;t++){var n,r=e[t],i=null;if(r.Site){if(i=r.Site,F.isObjectEmpty(i)||!ge(i))return null}else r.Facebook?(n=r.Facebook,F.isObjectEmpty(n)||n.error||(i=ue(n))):r["Google Plus"]&&(r=r["Google Plus"],F.isObjectEmpty(r)||r.error||(i=ae(r)));if(i&&!F.isObjectEmpty(i)){i.tz||(i.tz=(new Date).toString().match(/([A-Z]+[\+-][0-9]+)/)[1]);break}}return i}},{key:"generateProfileEvent",value:function(e){if(!e||F.isObjectEmpty(e))return null;var t=pe.extractIdentifiersFromProfileObj(e);return 0<t.length&&function(e){var t=m.getIdentitiesMapKey(),n=M.getGUID();if(n&&e&&!(e.length<=0)){for(var r=m.read(t)||{},i=0;i<e.length;i++){var o=e[i];o.type&&o.id&&(r[o.type+"_"+o.id]=n)}m.save(t,r)}}(t),{ep:F.getNow(),type:s.EVENT_TYPES.PROFILE,profile:e}}}]),pe);function pe(e,t){if(r(this,pe),this.api=e,ve.push=function(e){e=pe.generateProfileObj(e),e=pe.generateProfileEvent(e);this.api.processEvent(e)}.bind(this),t&&0<t.length)for(var n=0;n<t.length;n++)this.push(t[n])}var he=(i(ye,[{key:"send",value:function(e){var t=new XMLHttpRequest({mozSystem:!0});t.open("post",this.url,!0),t.responseType="json",t.addEventListener("error",function(){e&&e(t.status,t.error)}),t.addEventListener("load",function(){e&&e(t.status,t.response)}),t.setRequestHeader("Accept","application/json"),t.setRequestHeader("Content-Type","application/json"),t.send(JSON.stringify(this.data)),F.log.debug("req snt -> url: "+this.url)}}]),ye);function ye(e,t){r(this,ye),this.url=e,this.data=t||[]}function Ee(){return m.getARPKey()}var _e,Se,Ie=function(e){e=m.read(e);return F.isArray(e)?e:[]},me=function(e){e=m.read(e)||0;return parseInt(e,10)},be=function(){return m.getSavedEventsKey()},Te=function(){return m.getSavedProfilesKey()},ke=function(){return m.getSavedSequenceNumberKey()},Ae=(i(Pe,[{key:"clearEvents",value:function(e){var t=this;this._sendEvents(function(){t._unsentEvents=[],t._unsentProfiles=[],t._saveEvents(),e()})}},{key:"queueEvent",value:function(e){e&&(e._seq=this._nextSequenceNumber(),F.log.debug("Queuing event "+JSON.stringify(e)),(e.type===s.EVENT_TYPES.PROFILE?this._unsentProfiles:this._unsentEvents).push(e),this._saveEvents(),this._scheduleEvents())}},{key:"_getEndPoint",value:function(){var e=this.options.domain;return z.getRegion()&&(e=z.getRegion()+"."+this.options.domain),this.options.protocol+"//"+e+"/a2?t=77"}},{key:"_unsentCount",value:function(){return this._unsentEvents.length+this._unsentProfiles.length}},{key:"_scheduleRetry",value:function(){this.options.eventUploadRetryInterval=2*this.options.eventUploadRetryInterval,this._scheduleEvents(null,!0)}},{key:"_scheduleEvents",value:function(e,t){if(0===this._unsentCount())return F.log.debug("No events in the queue, not scheduling an event update"),!1;if(this._unsentCount()>=this.options.eventUploadThreshold)return this._sendEvents(e),!0;if(this._requestScheduled)return F.log.debug("Event upload already scheduled"),!1;this._requestScheduled=!0;t=t?this.options.eventUploadRetryInterval:this.options.eventUploadInterval;return setTimeout(function(){this._requestScheduled=!1,this._sendEvents(e)}.bind(this),t),F.log.debug("Scheduling an event upload in "+t/1e3+" seconds"),!1}},{key:"_sendEvents",value:function(n){var e=!1,t="";if(this._uploading&&(e=!0,t="Already Uploading"),this._unsentCount()<=0&&(e=!0,t="No events in the queue"),e){var r="Skipping events upload: "+t;return F.log.debug(r),void("function"==typeof n&&n(0,r))}this._uploading=!0;e=this._getEndPoint(),e=this._addToURL(e,"sn",F.getNow());e=this._addARPToRequest(e),e=this._addToURL(e,"r",(new Date).getTime());t={id:z.getAccountId(),"SDK Version":1e4,s:""+te.getSessionId()};z.getAppVersion()&&(t.Version=""+z.getAppVersion());r=M.getGUID();r&&(e=this._addToURL(e,"gc",r),t.g=r),e=this._addToURL(e,"d",se(JSON.stringify(t)));var i=Math.min(this._unsentCount(),this.options.uploadBatchSize),t=this._mergeEventQueues(i),o=t.maxEventId,s=t.maxProfilesId,t=t.eventsToSend;F.log.debug("Sending events: "+JSON.stringify(t));var a=this;new he(e,t).send(function(e,t){a._uploading=!1,t=t||{},F.log.debug("handling response with status: "+e+" and data: "+JSON.stringify(t));try{200===e?(t.g&&M.setGUID(t.g),t.KVAPID&&(F.log.debug("kaios vapid recieved: "+t.KVAPID),M.setVAPID(t.KVAPID)),t.kaiosPush&&(F.log.debug("kaios notification status: "+t.kaiosPush),M.setKaiOsNotificationState(t.kaiosPush)),a._removeEvents(o,s),a._saveEvents(),a._updateARP(t),a._scheduleEvents(n)||"function"!=typeof n||n(e,t)):413===e?(F.log.error("event upload request too large"),1===a.options.uploadBatchSize&&a._removeEvents(o,s),a.options.uploadBatchSize=Math.ceil(i/2),a._sendEvents(n)):(F.log.error("Events upload failed with status "+e+".  Will retry."),a._scheduleRetry(),"function"==typeof n&&n(e,t))}catch(e){a._uploading=!1,F.log.error("Events upload failed: "+e.message+".  Will retry."),a._scheduleRetry()}})}},{key:"_unregisterTokenApiCall",value:function(e,n){var t=this._getEndPoint(),t=this._addToURL(t,"sn",F.getNow());t=this._addARPToRequest(t),t=this._addToURL(t,"r",(new Date).getTime());var r={id:z.getAccountId(),"SDK Version":1e4,s:""+te.getSessionId()};z.getAppVersion()&&(r.Version=""+z.getAppVersion());var i=e.g;i&&(t=this._addToURL(t,"gc",i),r.g=i),F.log.debug("kaios vapid req with request url : "+t+" and meta: "+r),t=this._addToURL(t,"d",se(JSON.stringify(r))),F.log.debug("Sending kaios-Token unregister request: "+JSON.stringify(e));r=[];r.push(e),new he(t,r).send(function(e,t){t=t||{},F.log.debug("kaios req handling response with status: "+e+" and data: "+JSON.stringify(t));try{200===e?"function"==typeof n&&n():F.log.error("kaios vapid request failed with status "+e+".")}catch(e){F.log.error("kaios vapid request failed: "+e.message+".")}})}},{key:"_saveEvents",value:function(){m.save(be(),this._unsentEvents),m.save(Te(),this._unsentProfiles)}},{key:"_trimEventsQueued",value:function(e){e.length>this.options.maxSavedEventCount&&e.splice(0,e.length-this.options.maxSavedEventCount)}},{key:"_removeEvents",value:function(e,t){this._removeEventsFromQueue("_unsentEvents",e),this._removeEventsFromQueue("_unsentProfiles",t)}},{key:"_removeEventsFromQueue",value:function(e,t){if(!(t<0)){for(var n=[],r=0;r<this[e].length;r++)this[e][r]._seq>t&&n.push(this[e][r]);this[e]=n}}},{key:"_nextSequenceNumber",value:function(){return this._sequenceNumber++,m.save(ke(),this._sequenceNumber),this._sequenceNumber}},{key:"_mergeEventQueues",value:function(e){for(var t=[],n=0,r=-1,i=0,o=-1;t.length<e;){var s,a=i>=this._unsentProfiles.length,u=n>=this._unsentEvents.length;if(u&&a){F.log.error("Problem merging event queues, fewer events than expected");break}a||!u&&this._unsentEvents[n]._seq<this._unsentProfiles[i]._seq?r=(s=this._unsentEvents[n++])._seq:o=(s=this._unsentProfiles[i++])._seq,t.push(s)}return{eventsToSend:t,maxEventId:r,maxProfilesId:o}}},{key:"_updateARP",value:function(){var e=(0<arguments.length&&void 0!==arguments[0]?arguments[0]:{}).arp;if(e){var t=Ee();try{var n,r=m.read(t)||{};for(n in e)e.hasOwnProperty(n)&&(-1===e[n]?delete r[n]:r[n]=e[n]);m.save(t,r)}catch(e){F.log.error("Unable to parse ARP JSON: "+e)}}}},{key:"_addARPToRequest",value:function(e){var t=Ee();if(!t)return e;t=m.read(t);return t?this._addToURL(e,"arp",se(JSON.stringify(t))):e}},{key:"_addToURL",value:function(e,t,n){return e+"&"+t+"="+encodeURIComponent(n)}}]),Pe);function Pe(e){r(this,Pe),this.options=e,this.options.eventUploadRetryInterval=this.options.eventUploadInterval,this._uploading=!1,this._requestScheduled=!1,this._unsentEvents=Ie(be()),this._unsentProfiles=Ie(Te()),this._sequenceNumber=me(ke()),this._scheduleEvents()}function Ne(e,t){e={type:e,ep:F.getNow()},t&&t(e)}var De=(i(Oe,[{key:"getCleverTapID",value:function(){return M.getGUID()}},{key:"getTimeElapsed",value:function(){return this._isPersonalizationActive()?this.session.getTimeElapsed():0}},{key:"getPageCount",value:function(){return this._isPersonalizationActive()?this.session.getPageCount():0}},{key:"getTotalVisits",value:function(){return this._isPersonalizationActive()?this.session.getTotalVisits():0}},{key:"getLastVisit",value:function(){return this._isPersonalizationActive()?this.session.getLastVisit():0}},{key:"getEventDetails",value:function(e){if(this._isPersonalizationActive()){var t=this._getEventsMap()[e];if(!t)return null;e={};return e.firstTime=new Date(1e3*t[1]),e.lastTime=new Date(1e3*t[2]),e.count=t[0],e}}},{key:"getProfileAttribute",value:function(e){if(this._isPersonalizationActive())return this._getProfilesMap()[e]}},{key:"processEvent",value:function(e){F.isObject(e)&&(e.type===s.EVENT_TYPES.EVENT&&this._addToLocalEventMap(e.evtName),e.type===s.EVENT_TYPES.PROFILE&&this._addToLocalProfileMap(e.profile),e=this._addSystemDataToObject(e,void 0),this.queueManager.queueEvent(e))}},{key:"onUserLogin",value:function(e){var t=this,n=fe.generateProfileObj(e),r=M.getGUID();if(r&&n){for(var i,o=fe.extractIdentifiersFromProfileObj(n)||[],e=0<o.length,s=0;s<o.length;s++){var a=o[s];if(a.type&&a.id&&(i=fe.getCachedGUIDForIdentity(a.type,a.id)))break}return!e||F.isAnonymousDevice()?(F.log.debug("onUserLogin: either don't have identifier or device is anonymous, associating profile "+JSON.stringify(n)+" with current user profile"),void this._processProfileEvent(n)):i&&i===r?(F.log.debug("onUserLogin: profile "+JSON.stringify(n)+" maps to current device id "+r+", using current user profile"),void this._processProfileEvent(n)):void(this.processingUserLogin?F.log.debug("Already processing onUserLogin for "+this.processingUserLoginKey+" , will not process for profile: "+JSON.stringify(n)):(this.processingUserLogin=!0,this.processingUserLoginKey=JSON.stringify(n),F.log.debug("Processing onUserLogin for "+this.processingUserLoginKey),this.unregisterToken(r),this.queueManager.clearEvents(function(){i?M.setGUID(i):M.generateGUID(),t._clearDataMaps(),t._newSession(),t._processProfileEvent(n),t.processingUserLogin=!1,t.processingUserLoginKey=null})))}}},{key:"unregisterToken",value:function(e){var t={};t.type=s.EVENT_TYPES.DATA,t.g=e,t.action="unregister",this.queueManager._unregisterTokenApiCall(t)}},{key:"_newSession",value:function(){this.session=new te(Object.assign({},this.options)),this._generateLaunchEvents()}},{key:"_generateLaunchEvents",value:function(){var t,n=this;t=function(e){n.processEvent(e)},Ne(s.EVENT_TYPES.EVENT,function(e){e.evtName=s.APP_LAUNCHED,e.evtData={"SDK Version":1e4},z.getAppVersion()&&(e.evtData.Version=""+z.getAppVersion()),t&&t(e)}),this.options.sendPages&&Ne(s.EVENT_TYPES.PAGE,function(e){n.processEvent(e)})}},{key:"registerSW",value:function(e,t){var n=this,r=null;F.log.debug("---------\x3eregisterSW--\x3e",navigator),"serviceWorker"in navigator&&"PushManager"in window?(F.log.debug("Service Worker and Push is supported"),navigator.serviceWorker.register(e).then(function(e){r=e,console.log("Subscription data: ",e),console.log("Registration succeeded."),t?r.unregister().then(function(e){F.log.debug("Service worker unregistered attempt, success: "+e),M.setLastSWUnregistrationForVersion(M.getAppVersion())}):n.triggerPushSubscription(r)}).catch(function(e){console.error("Service Worker Error",e)})):console.warn("Push messaging is not supported")}},{key:"triggerPushSubscription",value:function(e){var t=this,n=M.getVAPID(),r={};console.log("subscribing push notification sw "+n),e.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:this.urlBase64ToUint8Array(n)}).then(function(e){console.log("pushManager Subscription data: ",e.toJSON()),console.log("applicationserverykey",e.options.applicationServerKey),(r=JSON.parse(JSON.stringify(e))).endpoint=r.endpoint.split("/").pop(),r.browser="Kaios",t._startuploadPushToken(r);e=(new Date).getTime();M.setLastTokenUpdateTs(e)})}},{key:"urlBase64ToUint8Array",value:function(e){for(var e=(e+"=".repeat((4-e.length%4)%4)).replace(/-/g,"+").replace(/_/g,"/"),t=window.atob(e),n=new Uint8Array(t.length),r=0;r<t.length;++r)n[r]=t.charCodeAt(r);return n}},{key:"_startuploadPushToken",value:function(e){e.type=s.EVENT_TYPES.DATA,this.processEvent(e)}},{key:"_getEventsMap",value:function(){var e;return _e||(e=m.getUserEventsKey(),_e=m.read(e)||{}),_e}},{key:"_getProfilesMap",value:function(){var e;return Se||(e=m.getUserProfileKey(),Se=m.read(e)||{}),Se}},{key:"_clearDataMaps",value:function(){Se=_e=null}},{key:"_startPings",value:function(){var t;this.options.sendPings&&(t=this,setInterval(function(){Ne(s.EVENT_TYPES.PING,function(e){t.processEvent(e)})},s.PING_FREQ_IN_MILLIS))}},{key:"_isPersonalizationActive",value:function(){return this.options.enablePersonalization}},{key:"_processProfileEvent",value:function(e){e=fe.generateProfileEvent(e);this.processEvent(e)}},{key:"_addToLocalEventMap",value:function(e){var t,n,r;e&&(t=this._getEventsMap(),n=F.getNow(),(r=t[e])?(r[2]=n,r[0]++):((r=[]).push(1),r.push(n),r.push(n)),t[e]=r,r=m.getUserEventsKey(),m.save(r,t))}},{key:"_addToLocalProfileMap",value:function(e){if(e){var t,n=this._getProfilesMap();if(e._custom){var r,i=e._custom;for(r in i)i.hasOwnProperty(r)&&(e[r]=i[r]);delete e._custom}for(t in e)e.hasOwnProperty(t)&&(n[t]=e[t]);n._custom&&delete n._custom;var o=m.getUserProfileKey();m.save(o,n)}}},{key:"_addSystemDataToObject",value:function(e,t){t||(e=F.removeUnsupportedChars(e,function(e,t){F.reportError(e,t)}));t=c.popError();return t&&(e.wzrk_error=t),e.id=z.getAccountId(),M.getGUID()&&(e.g=M.getGUID()),e.s=te.getSessionId(),e.pg=this.session.getPageCount(),e.f=this.session.isFirstSession(),e}}]),Oe);function Oe(e){r(this,Oe),this.options=e,this.queueManager=new Ae(Object.assign({},this.options)),this._newSession()}var we=[],Ue=function(e){if(F.isArray(e)){for(var t=null;0<e.length;){var n,r=e.shift();if(!F.isString(r))return void F.log.error(c.MESSAGES.event);1024<r.length&&(r=r.substring(0,1024),F.reportError(510,r+"... length exceeded 1024 chars. Trimmed.")),"Stayed"!==r&&"UTM Visited"!==r&&"App Launched"!==r&&"Notification Sent"!==r&&"Notification Viewed"!==r&&"Notification Clicked"!==r?(t={type:s.EVENT_TYPES.EVENT,ep:F.getNow(),evtName:F.sanitize(r,F.unsupportedKeyCharRegex)},0!==e.length&&(n=e.shift(),F.isObject(n)?"Charged"!==r?ce(n)?t.evtData=n:F.reportError(512,r+" event structure invalid. Not sent."):(de(n),F.reportError(511,"Charged event structure invalid. Not sent.")):e.unshift(n))):F.reportError(513,r+" is a restricted system event. It cannot be used as an event name.")}return t}},Ce=(i(Ke,[{key:"push",value:function(){return we.push(Array.prototype.slice.call(arguments)),!0}},{key:"getDetails",value:function(e){return this.api.getEventDetails(e)}}]),Ke);function Ke(e,t){if(r(this,Ke),this.api=e,we.push=function(e){e=Ue(e);this.api.processEvent(e)}.bind(this),t&&0<t.length)for(var n=0;n<t.length;n++)this.push(t[n])}var Re={domain:"wzrkt.com",protocol:"https:",enablePersonalization:!0,eventUploadInterval:1e3,eventUploadThreshold:50,maxSavedEventCount:1e3,uploadBatchSize:50,sendPages:!1,sendPings:!1},Ve=(i(Le,[{key:"getTimeElapsed",value:function(){return this.api.getTimeElapsed()}},{key:"getPageCount",value:function(){return this.api.getPageCount()}}]),Le);function Le(e){r(this,Le),this.api=e}var Fe=(i(Ge,[{key:"getTotalVisits",value:function(){return this.api.getTotalVisits()}},{key:"getLastVisit",value:function(){return this.api.getLastVisit()}}]),Ge);function Ge(e){r(this,Ge),this.api=e}var Me=[],je=(i(xe,[{key:"push",value:function(){return Me.push(Array.prototype.slice.call(arguments)),!0}}]),xe);function xe(e,t){if(r(this,xe),this.api=e,Me.push=function(e){this.api.onUserLogin(e)}.bind(this),t&&0<t.length)for(var n=0;n<t.length;n++)this.push(t[n])}function qe(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};r(this,qe),this.options=Object.assign({},Re),this.event=e.event||[],this.profile=e.profile||[],this.onUserLogin=e.onUserLogin||[],this.logLevels=F.logLevels,this.swpath="/serviceWorker.js"}return new(i(qe,[{key:"init",value:function(e,t){F.isEmptyString(e)?F.log.error(c.MESSAGES.init):(z.setAccountId(e),z.setRegion(t),this.api=new De(Object.assign({},this.options)),this.session=new Ve(this.api),this.user=new Fe(this.api),this.onUserLogin=new je(this.api,this.onUserLogin),this.event=new Ce(this.api,this.event),this.profile=new fe(this.api,this.profile),this._initiateTokenUpdateIfNeeded())}},{key:"setSWPath",value:function(e){this.swpath=e}},{key:"getCleverTapID",value:function(){return this.api.getCleverTapID()}},{key:"setLogLevel",value:function(e){F.setLogLevel(e)}},{key:"getLogLevel",value:function(){return F.getLogLevel()}},{key:"setAppVersion",value:function(e){z.setAppVersion(e)}},{key:"getAppVersion",value:function(){return z.getAppVersion()}},{key:"_registerCTNotifications",value:function(e,t){e?this.swpath=e:e=this.swpath,F.log.debug("register initiated, vapid: "+M.getVAPID()),M.getVAPID()&&M.getKaiOsNotificationState()?null!==this.api?(F.log.debug("registering SW callled"),this.api.registerSW(e,t)):F.log.debug("clevertap-Api context not available "+this.api):F.log.debug("Service Worker Subscription from client failed: Vapid-key: "+M.getVAPID()+" Notification Enabled:"+M.getKaiOsNotificationState())}},{key:"registerCTNotifications",value:function(e){this._registerCTNotifications(e,!1)}},{key:"_initiateTokenUpdateIfNeeded",value:function(){F.log.debug("token updating: for vapid: "+M.getVAPID()+"notification state:"+M.getKaiOsNotificationState());var e=M.getLastTokenUpdateTs(),t=e+864e5;F.log.debug("lastTokenUpdateTs + day : "+t);var n=(new Date).getTime(),r=M.getLastSWUnregistrationForVersion();null!==e&&(F.log.debug("Updating token as curTs: "+n+"and a day after last token update is : "+t),r!==M.getAppVersion()?this._registerCTNotifications(this.swpath,!0):this._registerCTNotifications(this.swpath,!1))}}]),qe)(window.clevertap)});
